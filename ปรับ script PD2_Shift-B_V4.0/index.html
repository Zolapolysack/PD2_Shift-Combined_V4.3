<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกข้อมูลรายงานแผนกผลิต 2 - กะ B </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Kanit', sans-serif;
            font-feature-settings: "liga" 1, "kern" 1;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-size: 15px;
            line-height: 1.5;
            letter-spacing: 0.01em;
            font-weight: 300;
        }
        
        body {
            background: linear-gradient(135deg, #000000 0%, #088fd7 100%);
            min-height: 100vh;
            font-feature-settings: "liga" 1;
            text-rendering: optimizeLegibility;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .glass-strong {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .glass-light {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-glow, .button-glow {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-glow:hover, .button-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .btn-glow::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-glow:hover::before {
            left: 100%;
        }
        

        
        .btn-green { 
            background: linear-gradient(135deg, #16a34a, #22c55e);
            border: 2px solid #15803d;
        }
        .btn-green:hover { 
            background: linear-gradient(135deg, #15803d, #16a34a);
            box-shadow: 0 0 30px rgba(22, 197, 94, 0.6), 0 0 60px rgba(34, 197, 94, 0.3);
            border-color: #22c55e;
        }
        
        .btn-orange { 
            background: linear-gradient(135deg, #ea580c, #f97316);
            border: 2px solid #c2410c;
        }
        .btn-orange:hover { 
            background: linear-gradient(135deg, #c2410c, #ea580c);
            box-shadow: 0 0 30px rgba(234, 88, 12, 0.6), 0 0 60px rgba(249, 115, 22, 0.3);
            border-color: #f97316;
        }
        
        .btn-blue { 
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            border: 2px solid #1d4ed8;
        }
        .btn-blue:hover { 
            background: linear-gradient(135deg, #1d4ed8, #2563eb);
            box-shadow: 0 0 30px rgba(37, 99, 235, 0.6), 0 0 60px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }
        
        .btn-red { 
            background: linear-gradient(135deg, #dc2626, #ef4444);
            border: 2px solid #b91c1c;
        }
        .btn-red:hover { 
            background: linear-gradient(135deg, #b91c1c, #dc2626);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.6), 0 0 60px rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }
        
        .btn-purple { 
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
            border: 2px solid #6d28d9;
        }
        .btn-purple:hover { 
            background: linear-gradient(135deg, #6d28d9, #7c3aed);
            box-shadow: 0 0 30px rgba(124, 58, 237, 0.6), 0 0 60px rgba(139, 92, 246, 0.3);
            border-color: #8b5cf6;
        }
        
        .input-field {
            transition: all 0.3s ease;
            font-size: 15px !important;
            font-weight: 400 !important;
            color: #374151 !important;
            letter-spacing: 0.01em;
            line-height: 1.4;
            border-width: 1px;
            background: #ffffff !important;
            border-color: #d1d5db !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 1px 2px rgba(0, 0, 0, 0.05);
            border-color: #3b82f6;
            outline: none;
            background: #ffffff !important;
        }
        
        .readonly-field {
            background: #d1d5db !important;
            color: #374151 !important;
            cursor: not-allowed;
            font-weight: 300 !important;
            font-size: 15px !important;
            border-color: #9ca3af !important;
            letter-spacing: 0.01em;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1) !important;
        }
        
        .data-set {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-step {
            transition: all 0.3s ease;
        }
        
        .progress-step.active {
            background: #16a34a;
            color: white;
        }
        
        .progress-step.completed {
            background: #059669;
            color: white;
        }
        
        .notification {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .modal-backdrop {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        @media (max-width: 768px) {
            .input-field {
                font-size: 16px !important;
            }
            
            .btn-glow, .button-glow {
                min-height: 44px;
            }
        }
    </style>
    <!-- LEGACY / OLD MOBILE SUPPORT START -->
    <style>
        /* Fallback พื้นหลัง (ถ้า gradient ไม่ทำงานจะยังเห็นสีหลัก) */
        body { background-color:#1e40af; }
        /* เมื่อไม่รองรับ backdrop-filter ให้ใช้พื้นหลังขาวโปร่งหนาแทน เพื่อให้อ่านง่ายบน iOS <12 / Android เก่า */
        .no-backdrop .glass,
        .no-backdrop .glass-strong,
        .no-backdrop .glass-light { 
            backdrop-filter:none !important; 
            -webkit-backdrop-filter:none !important; 
            background:rgba(255,255,255,0.88) !important; 
            border-color:rgba(0,0,0,0.08) !important;
        }
        /* ลดเอฟเฟกต์เงา/อนิเมชัน หากเครื่องเก่า (เราจะเติมคลาส reduced-effects จาก JS) */
        .reduced-effects * { transition:none !important; animation:none !important; }
        .reduced-effects .btn-glow:hover, .reduced-effects .button-glow:hover { transform:none !important; box-shadow:none !important; }
    </style>
    <script>
        /* Feature / capability detection + polyfills loader สำหรับเบราว์เซอร์เก่า */
        (function(){
            var docEl = document.documentElement;
            try {
                if(!(window.CSS && CSS.supports && CSS.supports('backdrop-filter: blur(4px)'))){
                    docEl.classList.add('no-backdrop');
                }
            } catch(e){ docEl.classList.add('no-backdrop'); }

            // ประเมินประสิทธิภาพคร่าว ๆ (อุปกรณ์เก่า: หน่วยความจำต่ำ / CPU ช้า -> ปิดอนิเมชันหนัก ๆ)
            if(navigator.hardwareConcurrency && navigator.hardwareConcurrency < 4){
                docEl.classList.add('reduced-effects');
            }

            // Polyfill: Promise
            if(typeof Promise === 'undefined'){
                var p = document.createElement('script');
                p.src = 'https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js';
                document.head.appendChild(p);
            }
            // Polyfill: fetch
            if(typeof fetch === 'undefined'){
                var f = document.createElement('script');
                f.src = 'https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.20/dist/fetch.umd.min.js';
                document.head.appendChild(f);
            }
            // Polyfill: IntersectionObserver (ใช้บางกรณีหากมีการเพิ่มภายหลัง)
            if(!('IntersectionObserver' in window)){
                var io = document.createElement('script');
                io.src = 'https://cdn.jsdelivr.net/npm/intersection-observer@0.12.2/intersection-observer.js';
                document.head.appendChild(io);
            }
            // NodeList.forEach บน IE / เก่ามาก (กันไว้เผื่อเปิดผ่าน WebView เก่า)
            if(window.NodeList && !NodeList.prototype.forEach){
                NodeList.prototype.forEach = Array.prototype.forEach;
            }
            // classList บาง WebView เก่าขาด (ตรวจผิวเผิน)
            if(!('classList' in document.createElement('_'))){
                try { (document.createElement('script').src='https://unpkg.com/classlist-polyfill@1.2.0/src/index.js'); } catch(e){}
            }
        })();
    </script>
    <!-- LEGACY / OLD MOBILE SUPPORT END -->
</head>
<body class="min-h-screen">
    <!-- Header Section -->
    <div class="glass-strong rounded-lg mx-4 mt-4 p-6 mb-6">
        <div class="text-center mb-4">
            <h1 class="text-3xl font-medium text-gray-800 tracking-normal leading-relaxed">ระบบบันทึกข้อมูลรายงานแผนกผลิต 2</h1>
            <div class="w-16 h-0.5 bg-gray-400 mx-auto mt-3"></div>
        </div>
        
        <!-- Status Bar -->
        <div class="flex items-center justify-between bg-white bg-opacity-50 rounded-lg p-4">
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="statusGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle fill="url(#statusGrad)" cx="12" cy="12" r="10"/>
                    <path stroke="white" stroke-width="2" d="m9 12 2 2 4-4"/>
                </svg>
                <span class="font-normal text-gray-700 text-base">สถานะ: พร้อมใช้งาน</span>
            </div>
            
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="shiftGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle fill="url(#shiftGrad)" cx="12" cy="12" r="5"/>
                    <line stroke="white" stroke-width="2" x1="12" y1="1" x2="12" y2="3"/>
                    <line stroke="white" stroke-width="2" x1="12" y1="21" x2="12" y2="23"/>
                    <line stroke="white" stroke-width="2" x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line stroke="white" stroke-width="2" x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line stroke="white" stroke-width="2" x1="1" y1="12" x2="3" y2="12"/>
                    <line stroke="white" stroke-width="2" x1="21" y1="12" x2="23" y2="12"/>
                    <line stroke="white" stroke-width="2" x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line stroke="white" stroke-width="2" x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <span class="font-normal text-gray-700 text-base">สำหรับ กะ B (20:00-08:00 น.)</span>
            </div>
            
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="timeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle fill="url(#timeGrad)" cx="12" cy="12" r="10"/>
                    <polyline stroke="white" stroke-width="2" points="12,6 12,12 16,14"/>
                </svg>
                <span class="font-normal text-gray-700 text-base" id="currentTime"></span>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="glass rounded-lg mx-4 mb-6 p-6">
        <div class="flex justify-center">
            <div class="flex items-center bg-white bg-opacity-50 rounded-lg px-4 py-2">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="dataGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect fill="url(#dataGrad)" x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line stroke="white" stroke-width="2" x1="16" y1="2" x2="16" y2="6"/>
                    <line stroke="white" stroke-width="2" x1="8" y1="2" x2="8" y2="6"/>
                    <line stroke="white" stroke-width="2" x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <span class="font-normal text-gray-700 text-base">จำนวนชุดข้อมูล: <span id="dataSetCount" class="text-blue-600 font-medium">1</span>/100</span>
            </div>
        </div>
    </div>

    <!-- Data Entry Container -->
    <div id="dataContainer" class="mx-4 space-y-6">
        <!-- Data sets will be generated here -->
    </div>

    <!-- Quick Actions Box -->
    <div class="glass rounded-lg mx-4 my-6 p-6">
        <div class="flex flex-wrap gap-4 justify-center">
            <button onclick="addDataSet()" class="btn-glow btn-green text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                </svg>
                เพิ่มชุดข้อมูลใหม่
            </button>
            
            <button onclick="copyAndAddDataSet()" class="btn-glow btn-blue text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                </svg>
                คัดลอกโดยเพิ่มชุดข้อมูล
            </button>
            
            <button onclick="clearLocalStorage()" class="btn-glow btn-red text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                ล้างข้อมูลชั่วคราว
            </button>
            
            <button onclick="showSystemHealth()" class="btn-glow bg-cyan-500 hover:bg-cyan-600 text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                ตรวจสอบระบบ
            </button>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="glass rounded-lg mx-4 my-6 p-6">
        <div class="flex flex-wrap gap-4 justify-center">
            <button onclick="saveToLocalStorage(true)" class="btn-glow btn-purple text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                </svg>
                บันทึกชั่วคราว
            </button>
            
            <button onclick="submitData()" class="btn-glow btn-orange text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                บันทึกข้อมูลทั้งหมด
            </button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Machine Modal -->
    <div id="machineModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="glass-strong rounded-lg max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="machineGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#7c3aed;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#5b21b6;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect fill="url(#machineGrad)" x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                        <line stroke="white" stroke-width="2" x1="8" y1="21" x2="16" y2="21"/>
                        <line stroke="white" stroke-width="2" x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    เพิ่มเครื่องทอใหม่
                </h3>
                <button onclick="closeModal('machine')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newMachine" placeholder="เช่น CL96" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('machine')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    บันทึก
                </button>
                <button onclick="closeModal('machine')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <!-- Employee Modal -->
    <div id="employeeModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="glass-strong rounded-lg max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="employeeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#059669;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#047857;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path fill="url(#employeeGrad)" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    เพิ่มพนักงานใหม่
                </h3>
                <button onclick="closeModal('employee')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newEmployeeId" placeholder="รหัสพนักงาน เช่น ZP99999" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-3">
            <input type="text" id="newEmployeeName" placeholder="ชื่อ-นามสกุล" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('employee')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    บันทึก
                </button>
                <button onclick="closeModal('employee')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <!-- Fabric Size Modal -->
    <div id="fabricModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="glass-strong rounded-lg max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="fabricGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#dc2626;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#b91c1c;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect fill="url(#fabricGrad)" x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <path stroke="white" stroke-width="2" d="m9 9 3 3-3 3m6-6h-6"/>
                    </svg>
                    เพิ่มขนาดหน้าผ้าใหม่
                </h3>
                <button onclick="closeModal('fabric')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newFabricSize" placeholder="เช่น 2025800SMN" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('fabric')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    บันทึก
                </button>
                <button onclick="closeModal('fabric')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center">
        <div class="glass-strong rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">กำลังบันทึกข้อมูล</h3>
                <p class="text-gray-600 mb-4" id="loadingStatus">กำลังเตรียมข้อมูล...</p>
                
                <!-- Progress Steps -->
                <div class="flex justify-between mb-4">
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step1">1</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step2">2</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step3">3</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step4">4</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step5">5</div>
                </div>
                
                <div class="text-sm text-gray-500">
                    <div>1. เตรียมข้อมูล</div>
                    <div>2. ตรวจสอบข้อมูล</div>
                    <div>3. เชื่อมต่อเซิร์ฟเวอร์</div>
                    <div>4. ส่งข้อมูล</div>
                    <div>5. ยืนยันการบันทึก</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Recovery Modal -->
    <div id="recoveryModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="glass-strong rounded-lg max-w-md w-full p-6">
            <div class="flex items-center mb-4">
                <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="recoveryGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#recoveryGrad)" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                </svg>
                <h3 class="text-xl font-bold text-gray-800">พบข้อมูลค้างส่ง</h3>
            </div>
            <p class="text-gray-600 mb-6">พบข้อมูลที่ยังไม่ได้ส่งจากครั้งก่อน คุณต้องการลองส่งใหม่หรือไม่?</p>
            <div class="flex gap-3">
                <button onclick="retryPendingSubmission()" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    ลองส่งใหม่
                </button>
                <button onclick="discardPendingSubmission()" class="btn-glow btn-red text-white px-6 py-2 rounded-lg font-semibold">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <!-- Removed usage instructions and 4 feature cards per request -->
    <!-- (previously: <div class="glass-light rounded-lg mx-4 mb-6 p-6"> ... </div>) -->

    <script>
        // Master Data Arrays
        const machines = [
            "CL1","CL2","CL3","CL4","CL5","CL6","CL7","CL8","CL9","CL12","CL13","CL14",
            "CL15","CL16","CL17","CL19","CL25","CL26","CL27","CL28","CL29","CL30","CL31",
            "CL32","CL33","CL44","CL45","CL46","CL47","CL48","CL49","CL50","CL51","CL52",
            "CL53","CL54","CL55","CL56","CL57","CL58","CL59","CL60","CL61","CL62","CL63",
            "CL64","CL65","CL66","CL67","CL68","CL69","CL70","CL71","CL72","CL73","CL74",
            "CL75","CL76","CL77","CL78","CL79","CL80","CL81","CL82","CL83","CL84","CL85",
            "CL86","CL87","CL88","CL89","CL90","CL91","CL92","CL93","CL94","CL95","CL91",
            "CL90","CL34","CL35","CL36"
        ];

        const employees = [
            { "id": "ZP91042", "name": "นาย วัน ชัย" },
            { "id": "ZP91385", "name": "นางสาว รัฐนันท์ นิธากรณ์" },
            { "id": "ZP92285", "name": "นายตาลซิน ออง" },
            { "id": "ZP91702", "name": "นาย พิว ไว จอ" },
            { "id": "ZP92237", "name": "ซอ พู ยา ซา" },
            { "id": "ZP92286", "name": "นางสาว ซิก เค่น" },
            { "id": "ZP92250", "name": "ยุน วา ติ" },
            { "id": "ZP91720", "name": "นางสาว จู จู ซาน" },
            { "id": "ZP92187", "name": "ติน โม แท็ค" },
            { "id": "ZP92282", "name": "ปาลามอน" },
            { "id": "ZP91922", "name": "นาย เพีย โซ อู" },
            { "id": "ZP92434", "name": "น.ส.ลำไย ใจชื่อ" },
            { "id": "ZP92471", "name": "นางมอว มอว วิน" },
            { "id": "ZP91512", "name": "นาง นัน มา เล ยี" },
            { "id": "ZP92321", "name": "น.ส.มะซูซูเย" },
            { "id": "ZP92491", "name": "นางมา ทาซิน มน" },
            { "id": "ZP91680", "name": "นาง ติน ซุย" },
            { "id": "ZP9499", "name": "นาง จำรัศ พุทธา" },
            { "id": "ZP91569", "name": "นาย วัชชระ ชะฎาดำ" },
            { "id": "ZP92350", "name": "นางสาว ซินมาลวิน" },
            { "id": "ZP91719", "name": "นาย พี พิว ออง" },
            { "id": "ZP9060", "name": "นางสาว อังคณา บุญธรรม" },
            { "id": "ZP92495", "name": "นางพรสวรรค์" },
            { "id": "ZP9174", "name": "นาง รัดดา ศรีทอง" },
            { "id": "ZP92186", "name": "ซามินอู" },
            { "id": "ZP92317", "name": "นาย ยาน ลิน ออง" },
            { "id": "ZP92402", "name": "นาย ลา วิน" },
            { "id": "ZP91718", "name": "นาย หม่อง ซอ" },
            { "id": "ZP92425", "name": "น.ส.วิ" },
            { "id": "ZP92318", "name": "น.ส.คินวิน" },
            { "id": "ZP91617", "name": "นาง พิไลพรรณ เตโช" },
            { "id": "ZP92481", "name": "นางสาว ติ่น ซา" },
            { "id": "ZP92390", "name": "นางสาว เอ วิน" },
            { "id": "ZP92107", "name": "นาง จี ปิยประภากุล" }
        ];

        const fabricSizes = [
"1425800",
"1725800",
"1825800SM",
"1921720",
"1925800",
"1925800SM",
"2021720UV",
"2021850UV",
"2025800",
"2025800SM",
"2025800SMN",
"2025850",
"2121670SM",
"2125650",
"2125800",
"2325650",
"2625650",
"262575051",
"2625800",
"2625850SM",
"2825850",
"scl052325650",
"test2025800",
"2321112512551"
        ];

        // API Configuration - ปรับปรุงให้รองรับการเปลี่ยนแปลง
        const API_CONFIG = {
            // Primary endpoint (updated 2025-08-13)
            endpoint: 'https://script.google.com/macros/s/AKfycbwB54QsV7zTiTWB64kLzJT22LHEqtsP0AH6mNdWoB3gKzTAMbjYUK55BAbDy77yEuUMZw/exec',
            
            // Backup endpoints (สำหรับกรณี primary ล้มเหลว)
            backupEndpoints: [
                'https://script.google.com/macros/s/BACKUP_URL_1/exec',
                'https://script.google.com/macros/s/BACKUP_URL_2/exec'
            ],
            
            sheetId: '1ZhDdKmzZSK0koExN2u_JsiF_SLAOanYyGtuewNAkFYU',
            folderId: '1vGSCN4Qf8XZNewfhpscW4BNZaHV8lvpe',
            
            // Timeout และ retry settings
            timeout: 30000, // 30 วินาที
            maxRetries: 5,
            retryDelay: 2000, // 2 วินาที
            
            // Version tracking
            apiVersion: '1.0',
            lastUpdated: '2024-12-19'
        };

        // Global Variables
        let dataSetCount = 1;
        let autoSaveInterval;
        let debounceTimer;
        
        // System Health Monitoring
        const SYSTEM_HEALTH = {
            lastSaveTime: null,
            saveFailureCount: 0,
            maxFailures: 10,
            isOnline: navigator.onLine,
            performanceMetrics: {
                loadTime: 0,
                saveTime: 0,
                errorCount: 0
            }
        };
        
        // Error Logging System
        const ERROR_LOG = {
            maxEntries: 100,
            entries: [],
            
            log: function(error, context = '') {
                const entry = {
                    timestamp: new Date().toISOString(),
                    error: error.toString(),
                    context: context,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                this.entries.unshift(entry);
                if (this.entries.length > this.maxEntries) {
                    this.entries.pop();
                }
                
                // Save to localStorage for debugging
                try {
                    LS.set('errorLog', JSON.stringify(this.entries));
                } catch (e) {
                    console.warn('Cannot save error log to localStorage');
                }
                
                console.error('System Error:', entry);
            },
            
            getRecentErrors: function(hours = 24) {
                const cutoff = new Date(Date.now() - hours * 60 * 60 * 1000);
                return this.entries.filter(entry => new Date(entry.timestamp) > cutoff);
            }
        };

        // Initialize System - ปรับปรุงให้แข็งแกร่งขึ้น
        document.addEventListener('DOMContentLoaded', function() {
            const startTime = performance.now();
            
            try {
                console.log('🚀 ระบบบันทึกข้อมูลรายงานแผนกผลิต 2 เริ่มต้นแล้ว');
                
                // Initialize system health monitoring
                initializeSystemHealth();
                
                // Setup error handling
                setupGlobalErrorHandling();
                
                // Initialize UI components
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                // Create initial data sets with error handling
                try {
                    const container = document.getElementById('dataContainer');
                    if (!container) {
                        throw new Error('Data container not found');
                    }
                    
                    for (let i = 1; i <= 1; i++) {
                        const newDataSet = document.createElement('div');
                        newDataSet.innerHTML = generateDataSet(i);
                        container.appendChild(newDataSet.firstElementChild);
                    }
                    dataSetCount = 1;
                    updateDataSetCount();
                } catch (error) {
                    ERROR_LOG.log(error, 'Initial data set creation');
                    showNotification('เกิดข้อผิดพลาดในการสร้างฟอร์ม กรุณาโหลดหน้าใหม่', 'error');
                }
                
                // Setup event listeners with error handling
                setupEventListeners();
                setupSelectHandlers();
                setupNetworkMonitoring();
                
                // Check for pending submissions
                checkForPendingSubmissions();
                
                // Setup auto-save with improved interval
                setupAutoSave();
                
                // Load existing data if available
                loadFromLocalStorage();
                
                // Performance tracking
                const loadTime = performance.now() - startTime;
                SYSTEM_HEALTH.performanceMetrics.loadTime = loadTime;
                console.log(`⚡ ระบบโหลดเสร็จใน ${loadTime.toFixed(2)}ms`);
                
                // Show system ready notification
                setTimeout(() => {
                    showNotification('ระบบพร้อมใช้งาน', 'success');
                }, 1000);
                
            } catch (error) {
                ERROR_LOG.log(error, 'System initialization');
                console.error('❌ เกิดข้อผิดพลาดในการเริ่มต้นระบบ:', error);
                showNotification('เกิดข้อผิดพลาดในการเริ่มต้นระบบ กรุณาโหลดหน้าใหม่', 'error');
            }
        });

        // System Health Functions
        function initializeSystemHealth() {
            // Check browser compatibility
            if (!window.localStorage) {
                showNotification('เบราว์เซอร์ไม่รองรับการบันทึกข้อมูล', 'warning');
            }
            
            // Check available storage
            try {
                const testKey = 'storageTest';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
            } catch (e) {
                showNotification('พื้นที่จัดเก็บข้อมูลเต็ม กรุณาล้างข้อมูลเก่า', 'warning');
            }
            
            SYSTEM_HEALTH.isOnline = navigator.onLine;
        }
        
        function setupGlobalErrorHandling() {
            // Handle uncaught errors
            window.addEventListener('error', function(event) {
                ERROR_LOG.log(event.error, `Global error: ${event.filename}:${event.lineno}`);
                SYSTEM_HEALTH.performanceMetrics.errorCount++;
            });
            
            // Handle unhandled promise rejections
            window.addEventListener('unhandledrejection', function(event) {
                ERROR_LOG.log(event.reason, 'Unhandled promise rejection');
                SYSTEM_HEALTH.performanceMetrics.errorCount++;
            });
        }
        
        function setupNetworkMonitoring() {
            // Monitor online/offline status
            window.addEventListener('online', function() {
                SYSTEM_HEALTH.isOnline = true;
                showNotification('เชื่อมต่ออินเทอร์เน็ตแล้ว', 'success');
                
                // Try to sync pending data
                checkForPendingSubmissions();
            });
            
            window.addEventListener('offline', function() {
                SYSTEM_HEALTH.isOnline = false;
                showNotification('ไม่มีการเชื่อมต่ออินเทอร์เน็ต ข้อมูลจะถูกบันทึกไว้ในเครื่อง', 'warning');
            });
        }
        
        function setupAutoSave() {
            // Clear existing interval if any
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            // Auto-save every 3 minutes (reduced from 5 for better reliability)
            autoSaveInterval = setInterval(() => {
                try {
                    saveToLocalStorage();
                } catch (error) {
                    ERROR_LOG.log(error, 'Auto-save failed');
                }
            }, 180000);
            
            // Also save before page unload
            window.addEventListener('beforeunload', function(e) {
                try {
                    saveToLocalStorage();
                } catch (error) {
                    ERROR_LOG.log(error, 'Before unload save failed');
                }
            });
        }

        // Update current time display
        function updateCurrentTime() {
            try {
                const now = new Date();
                const timeString = now.toLocaleString('th-TH', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = timeString;
                }
            } catch (error) {
                ERROR_LOG.log(error, 'Update time failed');
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Prevent accidental page leave
            window.addEventListener('beforeunload', function(e) {
                const hasData = document.querySelectorAll('.data-set').length > 0;
                if (hasData) {
                    e.preventDefault();
                    e.returnValue = '';
                    saveToLocalStorage();
                }
            });

            // Auto-save on input changes
            document.addEventListener('input', function(e) {
                if (e.target.matches('.input-field')) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(saveToLocalStorage, 2000);
                }
            });
        }

        // Generate Data Set HTML
        function generateDataSet(setNumber) {
            const today = new Date().toISOString().split('T')[0];
            
            return `
                <div class="data-set glass rounded-lg p-6 mb-6" data-set="${setNumber}">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-medium text-white flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <defs>
                                    <linearGradient id="setGrad${setNumber}" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect fill="url(#setGrad${setNumber})" x="3" y="4" width="18" height="15" rx="2" ry="2"/>
                                <polyline stroke="white" stroke-width="2" points="16,10 12,14 8,10"/>
                            </svg>
                            ชุดข้อมูลที่ ${setNumber}
                        </h2>
                        ${setNumber > 1 ? `
                            <button onclick="removeDataSet(${setNumber})" class="btn-glow btn-red text-white px-3 py-2 rounded-lg font-normal text-sm flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                                ลบชุดข้อมูล
                            </button>
                        ` : ''}
                    </div>

                    <div class="grid lg:grid-cols-2 gap-6">
                        <!-- ข้อมูลพื้นฐาน -->
                        <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                            <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="basicGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#1d4ed8;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    <circle fill="url(#basicGrad)" cx="12" cy="12" r="10"/>
                                    <path stroke="white" stroke-width="2" d="m9 12 2 2 4-4"/>
                                </svg>
                                ข้อมูลพื้นฐาน
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">วันที่</label>
                                    <input type="date" name="date_${setNumber}" value="${today}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">เครื่องทอ NO</label>
                                    <select name="machine_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="">เลือกเครื่องทอ</option>
                                        ${machines.map(machine => `<option value="${machine}">${machine}</option>`).join('')}
                                        <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">ชื่อพนักงานทอ กะ B</label>
                                    <select name="employeeA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="">เลือกพนักงาน</option>
                                        ${employees.map(emp => `<option value="${emp.id}">${emp.id} - ${emp.name}</option>`).join('')}
                                        <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">ชื่อพนักงานทอ กะ A</label>
                                    <input type="text" name="employeeB_${setNumber}" placeholder="ไม่สามารถแก้ไขได้" class="readonly-field w-full p-3 border border-gray-300 rounded-lg text-center" readonly disabled>
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">ขนาดหน้าผ้า</label>
                                    <select name="fabricSize_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="">เลือกขนาดหน้าผ้า</option>
                                        ${fabricSizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                                        <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- ข้อมูลการผลิต -->
                        <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                            <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="prodGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    <rect fill="url(#prodGrad)" x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                    <line stroke="white" stroke-width="2" x1="8" y1="21" x2="16" y2="21"/>
                                    <line stroke="white" stroke-width="2" x1="12" y1="17" x2="12" y2="21"/>
                                </svg>
                                ข้อมูลการผลิต
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">ขนาด Lot.No</label>
                                    <input type="text" name="lotNo_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="กรอกขนาด Lot.No">
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">เลขที่ใบสั่งผลิต</label>
                                    <input type="text" name="orderNo_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="กรอกเลขที่ใบสั่งผลิต">
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">ยอดทอ กะ B</label>
                                        <input type="number" name="productionA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="เช่น 800">
                                    </div>
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">ยอดทอ กะ A</label>
                                        <input type="number" name="productionB_${setNumber}" placeholder="ไม่สามารถแก้ไขได้" class="readonly-field w-full p-3 border border-gray-300 rounded-lg text-center" readonly disabled>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">ความเร็วรอบ กะ B</label>
                                        <input type="number" name="speedA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="เช่น 120">
                                    </div>
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">ความเร็วรอบ กะ A</label>
                                        <input type="number" name="speedB_${setNumber}" placeholder="ไม่สามารถแก้ไขได้" class="readonly-field w-full p-3 border border-gray-300 rounded-lg text-center" readonly disabled>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">ประสิทธิภาพ กะ B%</label>
                                        <input type="number" name="efficiencyA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="เช่น 65" min="0" max="100">
                                    </div>
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">ประสิทธิภาพ กะ A%</label>
                                        <input type="number" name="efficiencyB_${setNumber}" placeholder="ไม่สามารถแก้ไขได้" class="readonly-field w-full p-3 border border-gray-300 rounded-lg text-center" readonly disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- เลขมิเตอร์และความยาว -->
                    <div class="grid lg:grid-cols-2 gap-6 mt-6">
                        <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                            <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="meterGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    <circle fill="url(#meterGrad)" cx="12" cy="12" r="10"/>
                                    <polyline stroke="white" stroke-width="2" points="12,6 12,12 16,14"/>
                                </svg>
                                เลขมิเตอร์ประจำวัน
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">กะ B: เริ่มงาน</label>
                                    <input type="number" name="meterStartA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="เช่น 500">
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">กะ B: เลิกงาน</label>
                                    <input type="number" name="meterEndA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="เช่น 1000">
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">กะ A: เริ่มงาน</label>
                                    <input type="number" name="meterStartB_${setNumber}" placeholder="ไม่สามารถแก้ไขได้" class="readonly-field w-full p-3 border border-gray-300 rounded-lg text-center" readonly disabled>
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">กะ A: เลิกงาน</label>
                                    <input type="number" name="meterEndB_${setNumber}" placeholder="ไม่สามารถแก้ไขได้" class="readonly-field w-full p-3 border border-gray-300 rounded-lg text-center" readonly disabled>
                                </div>
                            </div>
                        </div>

                        <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                            <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="lengthGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#06b6d4;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#0891b2;stop-opacity:1" />
                                        </linearGradient>
                                        <filter id="lengthGlow">
                                            <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                            <feMerge> 
                                                <feMergeNode in="coloredBlur"/>
                                                <feMergeNode in="SourceGraphic"/>
                                            </feMerge>
                                        </filter>
                                    </defs>
                                    <circle fill="url(#lengthGrad)" cx="12" cy="12" r="10" filter="url(#lengthGlow)"/>
                                    <path stroke="white" stroke-width="2" d="M8 8h8M8 12h8M8 16h8"/>
                                    <circle fill="white" cx="6" cy="8" r="1"/>
                                    <circle fill="white" cx="6" cy="12" r="1"/>
                                    <circle fill="white" cx="6" cy="16" r="1"/>
                                    <path stroke="white" stroke-width="1.5" d="M18 6v12"/>
                                </svg>
                                ความยาวตัดม้วน (เมตร)
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">กะ B</label>
                                    <input type="number" name="lengthA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="เช่น 2500" step="0.01">
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">กะ A</label>
                                    <input type="number" name="lengthB_${setNumber}" placeholder="ไม่สามารถแก้ไขได้" class="readonly-field w-full p-3 border border-gray-300 rounded-lg text-center" readonly disabled>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            `;
        }

        // Add Data Set
        function addDataSet() {
            if (dataSetCount >= 100) {
                showNotification('ไม่สามารถเพิ่มชุดข้อมูลได้ เนื่องจากถึงขีดจำกัด 100 ชุด', 'error');
                return;
            }
            
            dataSetCount++;
            const container = document.getElementById('dataContainer');
            const newDataSet = document.createElement('div');
            newDataSet.innerHTML = generateDataSet(dataSetCount);
            const newElement = newDataSet.firstElementChild;
            container.appendChild(newElement);
            
            updateDataSetCount();
            
            // Setup handlers after a short delay to ensure DOM is ready
            setTimeout(() => {
                setupSelectHandlers();
                showNotification(`เพิ่มชุดข้อมูลที่ ${dataSetCount} เรียบร้อยแล้ว`, 'green');
                
                // Scroll to new data set
                newElement.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // Copy and Add Data Set
        function copyAndAddDataSet() {
            if (dataSetCount >= 100) {
                showNotification('ไม่สามารถเพิ่มชุดข้อมูลได้ เนื่องจากถึงขีดจำกัด 100 ชุด', 'error');
                return;
            }
            
            const lastDataSet = document.querySelector(`[data-set="${dataSetCount}"]`);
            if (!lastDataSet) {
                addDataSet();
                return;
            }
            
            // Get data from last set
            const lastData = {};
            const inputs = lastDataSet.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (!input.readOnly && !input.disabled && input.value) {
                    const fieldName = input.name.replace(`_${dataSetCount}`, '');
                    lastData[fieldName] = input.value;
                }
            });
            
            // Create new data set
            dataSetCount++;
            const container = document.getElementById('dataContainer');
            const newDataSet = document.createElement('div');
            newDataSet.innerHTML = generateDataSet(dataSetCount);
            const newElement = newDataSet.firstElementChild;
            container.appendChild(newElement);
            
            // Fill with copied data after a short delay to ensure DOM is ready
            setTimeout(() => {
                const newInputs = newElement.querySelectorAll('input, select');
                newInputs.forEach(input => {
                    if (!input.readOnly && !input.disabled) {
                        const fieldName = input.name.replace(`_${dataSetCount}`, '');
                        if (lastData[fieldName]) {
                            input.value = lastData[fieldName];
                        }
                    }
                });
                
                // Setup handlers for the new data set
                setupSelectHandlers();
                
                showNotification(`คัดลอกและเพิ่มชุดข้อมูลที่ ${dataSetCount} เรียบร้อยแล้ว`, 'blue');
                
                // Scroll to new data set
                newElement.scrollIntoView({ behavior: 'smooth' });
            }, 100);
            
            updateDataSetCount();
        }

        // Remove Data Set
        function removeDataSet(setNumber) {
            if (dataSetCount <= 1) {
                showNotification('ไม่สามารถลบชุดข้อมูลสุดท้ายได้', 'error');
                return;
            }
            
            const dataSet = document.querySelector(`[data-set="${setNumber}"]`);
            if (dataSet) {
                dataSet.remove();
                dataSetCount--;
                updateDataSetCount();
                showNotification(`ลบชุดข้อมูลที่ ${setNumber} เรียบร้อยแล้ว`, 'red');
            }
        }

        // Update Data Set Count Display
        function updateDataSetCount() {
            document.getElementById('dataSetCount').textContent = dataSetCount;
        }


        // Setup Select Handlers
        function setupSelectHandlers() {
            document.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', function() {
                    if (this.value === 'ADD_NEW') {
                        const fieldType = this.name.includes('machine') ? 'machine' : 
                                        this.name.includes('employee') ? 'employee' : 'fabric';
                        openModal(fieldType);
                        this.value = ''; // Reset select
                    }
                });
            });
        }

        // Modal Functions
        function openModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            modal.classList.remove('hidden');
            
            // Clear previous inputs
            if (type === 'employee') {
                document.getElementById('newEmployeeId').value = '';
                document.getElementById('newEmployeeName').value = '';
            } else {
                document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}${type === 'fabric' ? 'Size' : ''}`).value = '';
            }
        }

        function closeModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            modal.classList.add('hidden');
        }

        function saveModalData(type) {
            let newValue = '';
            let isValid = false;
            
            if (type === 'employee') {
                const id = document.getElementById('newEmployeeId').value.trim();
                const name = document.getElementById('newEmployeeName').value.trim();
                
                if (id && name) {
                    newValue = id;
                    employees.push({ id: id, name: name });
                    isValid = true;
                }
            } else if (type === 'machine') {
                newValue = document.getElementById('newMachine').value.trim();
                if (newValue) {
                    machines.push(newValue);
                    isValid = true;
                }
            } else if (type === 'fabric') {
                newValue = document.getElementById('newFabricSize').value.trim();
                if (newValue) {
                    fabricSizes.push(newValue);
                    isValid = true;
                }
            }
            
            if (isValid) {
                updateAllSelects(type, newValue);
                closeModal(type);
                showNotification(`เพิ่มข้อมูลใหม่เรียบร้อยแล้ว`, 'success');
            } else {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
            }
        }

        // Update All Selects
        function updateAllSelects(type, newValue) {
            const selects = document.querySelectorAll(`select[name*="${type === 'employee' ? 'employee' : type === 'fabric' ? 'fabricSize' : 'machine'}"]`);
            
            selects.forEach(select => {
                // Remove old ADD_NEW option
                const addNewOption = select.querySelector('option[value="ADD_NEW"]');
                if (addNewOption) {
                    addNewOption.remove();
                }
                
                // Add new option
                const newOption = document.createElement('option');
                if (type === 'employee') {
                    const emp = employees.find(e => e.id === newValue);
                    newOption.value = newValue;
                    newOption.textContent = `${emp.id} - ${emp.name}`;
                } else {
                    newOption.value = newValue;
                    newOption.textContent = newValue;
                }
                select.appendChild(newOption);
                
                // Re-add ADD_NEW option
                const addNewOptionNew = document.createElement('option');
                addNewOptionNew.value = 'ADD_NEW';
                addNewOptionNew.textContent = 'คีย์ข้อมูลใหม่';
                select.appendChild(addNewOptionNew);
                
                // Select the new value
                select.value = newValue;
            });
        }

        // Refresh All Selects
        function refreshAllSelects() {
            // Refresh machine selects
            document.querySelectorAll('select[name*="machine"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `
                    <option value="">เลือกเครื่องทอ</option>
                    ${machines.map(machine => `<option value="${machine}">${machine}</option>`).join('')}
                    <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                `;
                select.value = currentValue;
            });
            
            // Refresh employee selects
            document.querySelectorAll('select[name*="employee"]').forEach(select => {
                if (!select.name.includes('employeeB')) {
                    const currentValue = select.value;
                    select.innerHTML = `
                        <option value="">เลือกพนักงาน</option>
                        ${employees.map(emp => `<option value="${emp.id}">${emp.id} - ${emp.name}</option>`).join('')}
                        <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                    `;
                    select.value = currentValue;
                }
            });
            
            // Refresh fabric selects
            document.querySelectorAll('select[name*="fabricSize"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `
                    <option value="">เลือกขนาดหน้าผ้า</option>
                    ${fabricSizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                    <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                `;
                select.value = currentValue;
            });
        }

        // Data Submission Functions
        async function submitData() {
            console.log('🚀 เริ่มต้นการส่งข้อมูล');
            
            const allData = collectAllData();
            if (!allData || allData.length === 0) {
                showNotification('ไม่พบข้อมูลที่จะส่ง', 'error');
                return;
            }
            
            // Save data for recovery before submission
            saveDataForRecovery(allData);
            
            showLoading();
            updateProgressStep(1);
            updateLoadingStatus('กำลังเตรียมข้อมูล...');
            
            const payload = {
                action: 'saveData',
                data: {
                    title: "รายงานแผนกผลิต 2 สำหรับ กะ A",
                    timestamp: new Date().toISOString(),
                    totalSets: allData.length,
                    data: allData
                },
                sheetId: API_CONFIG.sheetId,
                folderId: API_CONFIG.folderId,
                timestamp: new Date().toISOString()
            };
            
            try {
                await submitWithRetry(payload, 3, 1);
            } catch (error) {
                console.error('❌ การส่งข้อมูลล้มเหลว:', error);
                hideLoading();
                showNotification('การส่งข้อมูลล้มเหลว กรุณาลองใหม่อีกครั้ง', 'error');
            }
        }

        async function submitWithRetry(data, maxRetries, currentAttempt, useBackup = false) {
            console.log(`🔄 ความพยายามที่ ${currentAttempt}/${maxRetries}${useBackup ? ' (ใช้ backup)' : ''}`);
            updateProgressStep(2);
            updateLoadingStatus('กำลังตรวจสอบข้อมูล...');
            if (!SYSTEM_HEALTH.isOnline) throw new Error('ไม่มีการเชื่อมต่ออินเทอร์เน็ต');
            await new Promise(r => setTimeout(r, 1000));
            updateProgressStep(3);
            updateLoadingStatus('กำลังเชื่อมต่อเซิร์ฟเวอร์...');
            let endpoint = API_CONFIG.endpoint;
            if (useBackup && API_CONFIG.backupEndpoints.length > 0) {
                const backupIndex = (currentAttempt - 1) % API_CONFIG.backupEndpoints.length;
                endpoint = API_CONFIG.backupEndpoints[backupIndex];
                console.log(`🔄 ใช้ backup endpoint: ${endpoint}`);
            }
            try {
                const submissionId = (self.crypto && crypto.randomUUID ? crypto.randomUUID() : 'sub-' + Date.now() + '-' + Math.random().toString(16).slice(2));
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);
                const payload = { ...data, submissionId, systemInfo: { userAgent: navigator.userAgent, timestamp: new Date().toISOString(), attempt: currentAttempt, endpoint } };
                // แสดงขั้นตอนที่ 4 ชัดเจน ก่อนเริ่มส่งข้อมูล
                updateProgressStep(4);
                updateLoadingStatus('กำลังส่งข้อมูล...');
                await flushUI();
                // Simple request (หลบ preflight)
                const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload), signal: controller.signal, cache: 'no-store', keepalive: true });
                clearTimeout(timeoutId);
                let ok = response.ok; let txt=''; let json=null;
                try { txt = await response.text(); if (txt) { try { json = JSON.parse(txt); } catch(_){} } } catch(_){}
                const logicalSuccess = json && (json.success === true || json.status === 'ok');
                if (!ok || !logicalSuccess) {
                    const pending = { savedAt: new Date().toISOString(), submissionId, endpoint, httpStatus: response.status, ok, logicalSuccess, bodySample: (txt||'').slice(0,500), payload };
                    LS.set('pendingSubmission', JSON.stringify(pending));
                    throw new Error('การยืนยันผลล้มเหลว HTTP:' + response.status + ' successFlag:' + logicalSuccess);
                }
                updateProgressStep(5);
                updateLoadingStatus('ยืนยันการบันทึก...');
                await flushUI();
                LS.remove('pendingSubmission');
                SYSTEM_HEALTH.saveFailureCount = 0; SYSTEM_HEALTH.lastSaveTime = new Date();
                const totalRows = (data && data.data && data.data.data) ? data.data.data.length : 0;
                // หน่วงเล็กน้อยเพื่อให้ผู้ใช้เห็นสถานะขั้นตอนที่ 5
                await sleep(400);
                hideLoading();
                showNotification('บันทึกสำเร็จ '+ totalRows +' รายการ', 'orange');
                console.log('✅ ส่งข้อมูลสำเร็จ', { submissionId, totalRows, response: json });
            } catch (error) {
                const isLikelyCors = (error instanceof TypeError) || /fetch|network|cors/i.test(error.message || '');
                if (currentAttempt === 1 && isLikelyCors) {
                    try {
                        console.warn('⚠️ Simple POST ล้มเหลว อาจติด CORS -> ลอง JSONP');
                        // อัปเดตขั้นตอนเป็นการส่งข้อมูล ก่อนเริ่ม JSONP
                        updateProgressStep(4);
                        updateLoadingStatus('กำลังส่งข้อมูล...');
                        await flushUI();
                        const jsonpResult = await jsonpFallback(data, endpoint);
                        if (jsonpResult && jsonpResult.success) {
                            const totalRows = (data && data.data && data.data.data) ? data.data.data.length : 0;
                            updateProgressStep(5);
                            updateLoadingStatus('ยืนยันการบันทึก...');
                            await flushUI();
                            await sleep(400);
                            hideLoading();
                            showNotification('บันทึกสำเร็จ '+ totalRows +' รายการ', 'orange');
                            SYSTEM_HEALTH.saveFailureCount = 0; LS.remove('pendingSubmission');
                            return;
                        }
                    } catch (jsonpErr) { console.error('❌ JSONP fallback ล้มเหลว:', jsonpErr); }
                }
                console.error(`❌ ความพยายามที่ ${currentAttempt} ล้มเหลว:`, error);
                ERROR_LOG.log(error, `Submit attempt ${currentAttempt}`); SYSTEM_HEALTH.saveFailureCount++;
                if (currentAttempt < maxRetries) {
                    updateLoadingStatus(`กำลังลองใหม่... (${currentAttempt + 1}/${maxRetries})`);
                    const delay = API_CONFIG.retryDelay * Math.pow(2, currentAttempt - 1);
                    await new Promise(r => setTimeout(r, delay));
                    const shouldUseBackup = currentAttempt >= 2; return submitWithRetry(data, maxRetries, currentAttempt + 1, shouldUseBackup);
                } else {
                    if (SYSTEM_HEALTH.saveFailureCount >= SYSTEM_HEALTH.maxFailures) showNotification('ระบบมีปัญหาการส่งข้อมูลซ้ำๆ กรุณาติดต่อผู้ดูแลระบบ', 'error');
                    try { if (localStorage.getItem('pendingSubmission')) showNotification('ไม่สามารถยืนยันผล เซฟ pending รอส่งใหม่', 'warning'); } catch(_){}
                    throw error;
                }
            }
        }

        // JSONP fallback helper
        function jsonpFallback(originalPayload, endpoint) {
            return new Promise((resolve, reject) => {
                try {
                    if (!originalPayload || originalPayload.action !== 'saveData') return reject(new Error('JSONP รองรับเฉพาะ saveData'));
                    const minimal = { action: 'saveData', data: originalPayload.data };
                    const jsonStr = JSON.stringify(minimal);
                    const encoded = encodeURIComponent(jsonStr);
                    if (encoded.length > 7000) return reject(new Error('ข้อมูลยาวเกินไปสำหรับ JSONP'));
                    const cbName = '__jsonpCB_' + Date.now() + '_' + Math.random().toString(16).slice(2);
                    const url = endpoint + '?action=saveData&data=' + encoded + '&callback=' + cbName;
                    const script = document.createElement('script');
                    let timeoutId;
                    window[cbName] = function(resp){ clearTimeout(timeoutId); try { delete window[cbName]; } catch(_){} script.remove(); resolve(resp); };
                    script.onerror = function(){ clearTimeout(timeoutId); try { delete window[cbName]; } catch(_){} script.remove(); reject(new Error('JSONP script load error')); };
                    timeoutId = setTimeout(() => { try { delete window[cbName]; } catch(_){} script.remove(); reject(new Error('JSONP timeout')); }, 15000);
                    script.src = url; document.head.appendChild(script);
                } catch(err) { reject(err); }
            });
        }

        // Collect All Data
        function collectAllData() {
            const allData = [];
            const dataSets = document.querySelectorAll('.data-set');
            
            dataSets.forEach((dataSet, index) => {
                const setNumber = index + 1;
                const setData = {
                    setNumber: setNumber,
                    date: dataSet.querySelector(`[name="date_${setNumber}"]`)?.value || '',
                    machine: dataSet.querySelector(`[name="machine_${setNumber}"]`)?.value || '',
                    employeeA: dataSet.querySelector(`[name="employeeA_${setNumber}"]`)?.value || '',
                    fabricSize: dataSet.querySelector(`[name="fabricSize_${setNumber}"]`)?.value || '',
                    lotNo: dataSet.querySelector(`[name="lotNo_${setNumber}"]`)?.value || '',
                    orderNo: dataSet.querySelector(`[name="orderNo_${setNumber}"]`)?.value || '',
                    productionA: dataSet.querySelector(`[name="productionA_${setNumber}"]`)?.value || '',
                    speedA: dataSet.querySelector(`[name="speedA_${setNumber}"]`)?.value || '',
                    efficiencyA: dataSet.querySelector(`[name="efficiencyA_${setNumber}"]`)?.value || '',
                    meterStartA: dataSet.querySelector(`[name="meterStartA_${setNumber}"]`)?.value || '',
                    meterEndA: dataSet.querySelector(`[name="meterEndA_${setNumber}"]`)?.value || '',
                    lengthA: dataSet.querySelector(`[name="lengthA_${setNumber}"]`)?.value || ''
                };
                
                allData.push(setData);
            });
            
            return allData;
        }

        // Storage namespace helper (safe for combined UI)
        const SHIFT_ID = 'B';
        const LS = {
            _p: function(k){ return `PD2_SHIFT_${SHIFT_ID}_${k}`; },
            get: function(k){ try { return localStorage.getItem(this._p(k)); } catch(e){ return null; } },
            set: function(k,v){ try { localStorage.setItem(this._p(k), v); } catch(e){} },
            remove: function(k){ try { localStorage.removeItem(this._p(k)); } catch(e){} }
        };

        // Listen for parent frame commands when embedded
        try {
            window.addEventListener('message', function(ev){
                var msg = ev && ev.data;
                if (!msg || msg.shift && msg.shift !== SHIFT_ID) return; // ignore others
                if (msg && msg.cmd === 'save') { saveToLocalStorage(true); window.parent.postMessage({shift:SHIFT_ID, event:'saved'}, '*'); }
                if (msg && msg.cmd === 'load') { loadFromLocalStorage(); window.parent.postMessage({shift:SHIFT_ID, event:'loaded'}, '*'); }
                if (msg && msg.cmd === 'clear') { clearLocalStorage(); window.parent.postMessage({shift:SHIFT_ID, event:'cleared'}, '*'); }
            }, false);
        } catch(e){}

        // Storage Functions - ปรับปรุงให้แข็งแกร่งขึ้น
        function saveToLocalStorage() {
            const saveStartTime = performance.now();
            
            try {
                const allData = collectAllData();
                
                // Validate data before saving
                if (!allData || allData.length === 0) {
                    console.warn('⚠️ ไม่มีข้อมูลที่จะบันทึก');
                    return;
                }
                
                const storageData = {
                    version: '2.0', // เพิ่ม version tracking
                    timestamp: new Date().toISOString(),
                    dataSetCount: dataSetCount,
                    data: allData,
                    customMachines: machines.slice(75), // Only custom additions
                    customEmployees: employees.slice(34), // Only custom additions
                    customFabricSizes: fabricSizes.slice(22), // Only custom additions
                    systemHealth: {
                        saveTime: saveStartTime,
                        errorCount: SYSTEM_HEALTH.performanceMetrics.errorCount,
                        lastSaveTime: SYSTEM_HEALTH.lastSaveTime
                    }
                };
                
                // Check storage size before saving
                const dataSize = JSON.stringify(storageData).length;
                const maxSize = 5 * 1024 * 1024; // 5MB limit
                
                if (dataSize > maxSize) {
                    // Clean old data if size is too large
                    cleanOldStorageData();
                }
                
                // Create backup before overwriting (namespaced)
                const existingData = LS.get('productionData');
                if (existingData) {
                    LS.set('productionDataBackup', existingData);
                }
                
                LS.set('productionData', JSON.stringify(storageData));
                
                const saveTime = performance.now() - saveStartTime;
                SYSTEM_HEALTH.performanceMetrics.saveTime = saveTime;
                SYSTEM_HEALTH.lastSaveTime = new Date();
                
                console.log(`💾 บันทึกข้อมูลแล้ว (${saveTime.toFixed(2)}ms, ${(dataSize/1024).toFixed(2)}KB)`);
                
                // Only show notification if manually triggered
                if (arguments.length > 0 && arguments[0] === true) {
                    showNotification('บันทึกข้อมูลเรียบร้อยแล้ว', 'purple');
                }
                
            } catch (error) {
                ERROR_LOG.log(error, 'Save to localStorage failed');
                console.error('❌ ไม่สามารถบันทึกข้อมูลได้:', error);
                
                // Try to recover from backup
                if (error.name === 'QuotaExceededError') {
                    showNotification('พื้นที่จัดเก็บข้อมูลเต็ม กำลังล้างข้อมูลเก่า...', 'warning');
                    cleanOldStorageData();
                    
                    // Try saving again
                    try {
                        LS.set('productionData', JSON.stringify(storageData));
                        showNotification('บันทึกข้อมูลเรียบร้อยแล้ว', 'success');
                    } catch (retryError) {
                        showNotification('ไม่สามารถบันทึกข้อมูลได้ กรุณาล้างข้อมูลเก่า', 'error');
                    }
                } else {
                    showNotification('ไม่สามารถบันทึกข้อมูลได้', 'error');
                }
            }
        }
        
        function cleanOldStorageData() {
            try {
                // Remove old error logs (namespaced)
                const errorLog = LS.get('errorLog');
                if (errorLog) {
                    const logs = JSON.parse(errorLog);
                    const recentLogs = logs.slice(0, 50); // Keep only 50 recent entries
                    LS.set('errorLog', JSON.stringify(recentLogs));
                }
                
                // Remove old backup data
                LS.remove('productionDataBackup');
                
                // Remove other temporary data (global keys still checked)
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('temp_') || key.startsWith('old_') || key.includes('_PD2_SHIFT_B_'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                console.log(`🧹 ล้างข้อมูลเก่าแล้ว (${keysToRemove.length} รายการ)`);
                
            } catch (error) {
                ERROR_LOG.log(error, 'Clean old storage data failed');
                console.error('❌ ไม่สามารถล้างข้อมูลเก่าได้:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const stored = LS.get('productionData');
                if (!stored) {
                    console.log('ℹ️ ไม่พบข้อมูลที่บันทึกไว้');
                    return;
                }
                
                const storageData = JSON.parse(stored);
                
                // Restore custom data
                if (storageData.customMachines) {
                    machines.push(...storageData.customMachines);
                }
                if (storageData.customEmployees) {
                    employees.push(...storageData.customEmployees);
                }
                if (storageData.customFabricSizes) {
                    fabricSizes.push(...storageData.customFabricSizes);
                }
                
                // Clear existing data sets
                document.getElementById('dataContainer').innerHTML = '';
                
                // Restore data sets
                dataSetCount = storageData.dataSetCount || 1;
                for (let i = 1; i <= dataSetCount; i++) {
                    const container = document.getElementById('dataContainer');
                    const newDataSet = document.createElement('div');
                    newDataSet.innerHTML = generateDataSet(i);
                    container.appendChild(newDataSet.firstElementChild);
                }
                
                // Fill data
                if (storageData.data) {
                    storageData.data.forEach((setData, index) => {
                        const setNumber = index + 1;
                        const dataSet = document.querySelector(`[data-set="${setNumber}"]`);
                        if (dataSet) {
                            Object.keys(setData).forEach(key => {
                                if (key !== 'setNumber') {
                                    const input = dataSet.querySelector(`[name="${key}_${setNumber}"]`);
                                    if (input && !input.readOnly) {
                                        input.value = setData[key];
                                    }
                                }
                            });
                        }
                    });
                }
                
                updateDataSetCount();
                setupSelectHandlers();
                refreshAllSelects();
                
                console.log('📂 โหลดข้อมูลเรียบร้อยแล้ว');
                showNotification('โหลดข้อมูลเรียบร้อยแล้ว', 'success');
                
            } catch (error) {
                console.error('❌ ไม่สามารถโหลดข้อมูลได้:', error);
                showNotification('ไม่สามารถโหลดข้อมูลได้', 'error');
            }
        }

        function clearLocalStorage() {
            try {
                LS.remove('productionData');
                localStorage.removeItem('pendingSubmission');
                console.log('🗑️ ล้างข้อมูลแล้ว');
                showNotification('ล้างข้อมูลเรียบร้อยแล้ว', 'red');
            } catch (error) {
                console.error('❌ ไม่สามารถล้างข้อมูลได้:', error);
                showNotification('ไม่สามารถล้างข้อมูลได้', 'error');
            }
        }

        // Recovery System
        function saveDataForRecovery(data) {
            try {
                const recoveryData = {
                    timestamp: new Date().toISOString(),
                    data: data
                };
                LS.set('pendingSubmission', JSON.stringify(recoveryData));
                console.log('🔄 บันทึกข้อมูลสำหรับกู้คืน');
            } catch (error) {
                console.error('❌ ไม่สามารถบันทึกข้อมูลสำหรับกู้คืนได้:', error);
            }
        }

        function checkForPendingSubmissions() {
            try {
                const pending = LS.get('pendingSubmission');
                if (pending) {
                    const recoveryData = JSON.parse(pending);
                    const timestamp = new Date(recoveryData.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - timestamp) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 1) {
                        // Auto cleanup old data
                        LS.remove('pendingSubmission');
                        console.log('🧹 ลบข้อมูลค้างส่งที่เก่าแล้ว');
                    } else {
                        // Show recovery modal
                        document.getElementById('recoveryModal').classList.remove('hidden');
                        console.log('🔄 พบข้อมูลค้างส่ง');
                    }
                }
            } catch (error) {
                console.error('❌ ไม่สามารถตรวจสอบข้อมูลค้างส่งได้:', error);
            }
        }

        function retryPendingSubmission() {
            try {
                const pending = LS.get('pendingSubmission');
                if (pending) {
                    const recoveryData = JSON.parse(pending);
                    document.getElementById('recoveryModal').classList.add('hidden');
                    
                    const payload = {
                        action: 'saveData',
                        data: {
                            title: "รายงานแผนกผลิต 2 สำหรับ กะ A (กู้คืน)",
                            timestamp: recoveryData.timestamp,
                            totalSets: recoveryData.data.length,
                            data: recoveryData.data
                        },
                        sheetId: API_CONFIG.sheetId,
                        folderId: API_CONFIG.folderId,
                        timestamp: new Date().toISOString()
                    };
                    
                    showLoading();
                    submitWithRetry(payload, 3, 1);
                }
            } catch (error) {
                console.error('❌ ไม่สามารถลองส่งข้อมูลใหม่ได้:', error);
                showNotification('ไม่สามารถลองส่งข้อมูลใหม่ได้', 'error');
            }
        }

        function discardPendingSubmission() {
            LS.remove('pendingSubmission');
            document.getElementById('recoveryModal').classList.add('hidden');
            showNotification('ยกเลิกข้อมูลค้างส่งแล้ว', 'success');
        }

        // UI Management Functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            // Reset progress steps
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        function updateProgressStep(stepNumber) {
            // Mark previous steps as completed
            for (let i = 1; i < stepNumber; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active');
                step.classList.add('completed');
            }
            
            // Mark current step as active
            const currentStep = document.getElementById(`step${stepNumber}`);
            currentStep.classList.add('active');
            currentStep.classList.remove('completed');
        }

    // ช่วยให้ UI มีเวลาวาดผลลัพธ์ก่อนดำเนินการต่อ
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    function _nextFrame() { return new Promise(resolve => requestAnimationFrame(() => resolve())); }
    async function flushUI() { try { await _nextFrame(); await _nextFrame(); } catch(_) {} }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 
                           type === 'warning' ? 'bg-yellow-500' : 
                           type === 'green' ? 'bg-green-500' :
                           type === 'blue' ? 'bg-blue-500' :
                           type === 'purple' ? 'bg-purple-500' :
                           type === 'orange' ? 'bg-orange-500' :
                           type === 'red' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `notification ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg flex items-center max-w-sm`;
            
            const icon = type === 'success' ? '✅' : 
                        type === 'error' ? '❌' : 
                        type === 'warning' ? '⚠️' : 
                        type === 'green' ? '✅' :
                        type === 'blue' ? '✅' :
                        type === 'purple' ? '✅' :
                        type === 'orange' ? '✅' :
                        type === 'red' ? 'ℹ️' : 'ℹ️';
            
            notification.innerHTML = `
                <span class="mr-3 text-xl">${icon}</span>
                <span class="font-semibold">${message}</span>
            `;
            
            document.getElementById('notifications').appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // System Health Check Function
        function showSystemHealth() {
            const healthData = {
                online: SYSTEM_HEALTH.isOnline,
                lastSave: SYSTEM_HEALTH.lastSaveTime,
                saveFailures: SYSTEM_HEALTH.saveFailureCount,
                loadTime: SYSTEM_HEALTH.performanceMetrics.loadTime,
                saveTime: SYSTEM_HEALTH.performanceMetrics.saveTime,
                errorCount: SYSTEM_HEALTH.performanceMetrics.errorCount,
                recentErrors: ERROR_LOG.getRecentErrors(24),
                storageUsed: getStorageUsage(),
                browserInfo: {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine
                }
            };
            
            let healthStatus = '✅ ระบบทำงานปกติ';
            let healthColor = 'success';
            
            if (!healthData.online) {
                healthStatus = '⚠️ ไม่มีการเชื่อมต่ออินเทอร์เน็ต';
                healthColor = 'warning';
            } else if (healthData.saveFailures > 5) {
                healthStatus = '❌ ระบบมีปัญหาการส่งข้อมูล';
                healthColor = 'error';
            } else if (healthData.errorCount > 10) {
                healthStatus = '⚠️ พบข้อผิดพลาดหลายครั้ง';
                healthColor = 'warning';
            }
            
            const healthReport = `
สถานะระบบ: ${healthStatus}

📊 ข้อมูลประสิทธิภาพ:
- เวลาโหลดระบบ: ${healthData.loadTime.toFixed(2)}ms
- เวลาบันทึกข้อมูล: ${healthData.saveTime.toFixed(2)}ms
- จำนวนข้อผิดพลาด: ${healthData.errorCount}
- ความล้มเหลวในการส่ง: ${healthData.saveFailures}

💾 การใช้พื้นที่จัดเก็บ:
- ใช้แล้ว: ${(healthData.storageUsed.used/1024).toFixed(2)}KB
- เหลือ: ${(healthData.storageUsed.remaining/1024).toFixed(2)}KB

🌐 การเชื่อมต่อ:
- สถานะ: ${healthData.online ? 'เชื่อมต่อ' : 'ไม่เชื่อมต่อ'}
- บันทึกล่าสุด: ${healthData.lastSave ? new Date(healthData.lastSave).toLocaleString('th-TH') : 'ยังไม่เคย'}

${healthData.recentErrors.length > 0 ? `\n⚠️ ข้อผิดพลาดล่าสุด (24 ชม.):\n${healthData.recentErrors.slice(0, 3).map(e => `- ${e.error.substring(0, 50)}...`).join('\n')}` : ''}
            `;
            
            // Copy to clipboard for easy sharing
            if (navigator.clipboard) {
                navigator.clipboard.writeText(healthReport).then(() => {
                    showNotification('คัดลอกรายงานสุขภาพระบบแล้ว', 'success');
                });
            }
            
            console.log('🏥 รายงานสุขภาพระบบ:', healthData);
            alert(healthReport);
            showNotification(healthStatus, healthColor);
        }
        
        function getStorageUsage() {
            try {
                let used = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        used += localStorage[key].length + key.length;
                    }
                }
                
                // Estimate remaining space (5MB typical limit)
                const estimated = 5 * 1024 * 1024;
                return {
                    used: used,
                    remaining: Math.max(0, estimated - used)
                };
            } catch (error) {
                return { used: 0, remaining: 0 };
            }
        }

        // Note: First data set is already created in the main DOMContentLoaded event
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96bc15dfc4018967',t:'MTc1NDYyNTQwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
