<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ú‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        :root{
            --ais-green: #00b140; /* primary AIS-like green (assumption) */
            --ais-green-dark: #008f2a;
            --ais-accent: #9beab0;
            --ais-info: #00a3a3;
            --card-bg: rgba(255,255,255,0.95);
            --muted: #6b7280;
        }

        * {
            font-family: 'Kanit', sans-serif;
            font-feature-settings: "liga" 1, "kern" 1;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-size: 15px;
            line-height: 1.5;
            letter-spacing: 0.01em;
            font-weight: 300;
            min-height: 100vh;
            /* Modern multi-stop green gradient with subtle teal & lime accents */
            background: linear-gradient(135deg, #0d2a60 0%, #0298af 30%, #6103b8 60%, #0c3c64 100%);
            /* Fallback for older browsers */
            background-color: #0b7a4a;
            color: #e6fff0; /* soft off-white for contrast */
            background-attachment: fixed;
            -webkit-font-smoothing: antialiased;
        }

        /* Card surfaces updated to AIS theme */
        .glass {
            background: rgba(255,255,255,0.06);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0,177,64,0.07);
        }

        .glass-strong {
            background: var(--card-bg);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(3,50,26,0.06);
        }

        /* Header hero styling */
        .header-hero {
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.92));
            box-shadow: 0 10px 30px rgba(3,50,26,0.12), inset 0 1px 0 rgba(255,255,255,0.6);
            border-radius: 12px;
        }

        /* Decorative floating bubbles inside header */
        .header-bubbles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .header-bubbles .bubble {
            position: absolute;
            background: rgba(255,255,255,0.85);
            border-radius: 50%;
            filter: blur(0.6px);
            opacity: 0.9;
            transform: translateY(20px) scale(0.8);
            animation: floatUp 6s linear infinite;
        }

        .header-bubbles .bubble.small { width:8px;height:8px;opacity:0.7; }
        .header-bubbles .bubble.medium { width:14px;height:14px;opacity:0.85; }
        .header-bubbles .bubble.large { width:26px;height:26px;opacity:0.95; }

        @keyframes floatUp {
            0% { transform: translateY(20px) scale(0.8); opacity:0.6; }
            50% { opacity:0.95; }
            100% { transform: translateY(-38px) scale(1); opacity:0.0; }
        }

        .header-hero h1 { 
            text-shadow: 0 6px 18px rgba(3,50,26,0.12), 0 1px 0 rgba(255,255,255,0.6);
            color: #08321a;
            font-weight: 600;
        }

        .glass-light {
            background: rgba(255,255,255,0.04);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.06);
        }

        /* Modern vibrant button system */
        .btn-glow, .button-glow {
            transition: transform 160ms cubic-bezier(.2,.9,.2,1), box-shadow 160ms ease, filter 160ms ease;
            position: relative;
            overflow: hidden;
            will-change: transform, box-shadow, filter;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem; /* consistent padding */
            min-width: 160px; /* consistent width baseline */
            height: 44px;
            border-radius: 10px; /* modern rounded */
            color: white;
            text-shadow: 0 1px 0 rgba(0,0,0,0.25);
            box-shadow: 0 6px 18px rgba(6,12,34,0.12);
            border: none;
            cursor: pointer;
            margin: 6px; /* consistent spacing around buttons */
        }

        .btn-glow:hover, .button-glow:hover {
            transform: translateY(-4px);
            filter: brightness(1.08);
            box-shadow: 0 12px 30px rgba(6,12,34,0.18);
        }

        .btn-glow::after {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            transition: opacity 200ms ease;
            opacity: 0;
        }

        .btn-glow:active, .button-glow:active {
            transform: scale(0.97);
            box-shadow: 0 4px 10px rgba(6,12,34,0.08);
            transition: transform 120ms cubic-bezier(.2,.9,.2,1), box-shadow 120ms ease;
        }

        /* Primary AIS button (replaces btn-green look) */
        /* Primary AIS button */
        .btn-green {
            background: linear-gradient(135deg, #007a2f 0%, #00b140 100%);
        }

        .btn-green:hover { background: linear-gradient(135deg, #008f2a 0%, #31c77b 100%); }

        /* Info */
        .btn-ais-info {
            background: linear-gradient(135deg, #007b7b 0%, #22c7c7 100%);
        }
        .btn-ais-info:hover { background: linear-gradient(135deg, #006868 0%, #2bd1d1 100%); }

        .btn-orange {
            background: linear-gradient(135deg, #c84b00 0%, #ff8a00 100%);
        }
        .btn-orange:hover { background: linear-gradient(135deg, #d55a00 0%, #ff9a2b 100%); }

        .btn-blue {
            background: linear-gradient(135deg, #0b6b86 0%, #35c0e0 100%);
        }
        .btn-blue:hover { background: linear-gradient(135deg, #09607a 0%, #5fd3ee 100%); }

        .btn-red {
            background: linear-gradient(135deg, #c21b1b 0%, #ff5a5a 100%);
        }
        .btn-red:hover { background: linear-gradient(135deg, #a51616 0%, #ff6e6e 100%); }

        .btn-purple {
            background: linear-gradient(135deg, #4b2bd6 0%, #9b6bff 100%);
        }
        .btn-purple:hover { background: linear-gradient(135deg, #3d21c8 0%, #ad87ff 100%); }

        /* Ensure all buttons share white text and subtle text shadow */
        .btn-glow, .button-glow, .btn-green, .btn-ais-info, .btn-orange, .btn-blue, .btn-red, .btn-purple {
            color: #ffffff;
            text-shadow: 0 1px 0 rgba(0,0,0,0.25);
        }

        /* Standardized input appearance for aligned form fields */
        .input-field {
            transition: all 0.18s ease;
            font-size: 15px !important;
            font-weight: 400 !important;
            color: #08321a !important;
            letter-spacing: 0.01em;
            line-height: 1.4;
            padding: 0.6rem 0.75rem;
            background: #ffffff !important;
            border: 1px solid rgba(255,255,255,0.9) !important; /* thin white border */
            border-radius: 6px; /* small rounded corners */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.03);
            height: 44px; /* consistent height */
            min-height: 44px;
            width: 100%; /* consistent width within its column */
            box-sizing: border-box;
        }

        /* Hover shows a clearer white border */
        .input-field:hover {
            border-color: rgba(255,255,255,1) !important;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.06);
        }

        /* Keep focus visual (green) but preserve consistent sizing */
        .input-field:focus {
            box-shadow: 0 0 0 4px rgba(0,177,64,0.08), 0 1px 2px rgba(0,0,0,0.04);
            border-color: var(--ais-green-dark) !important;
            outline: none;
            background: #fff !important;
        }

        .readonly-field {
            background: #f3f7f3 !important;
            color: #08321a !important;
            cursor: not-allowed;
            font-weight: 300 !important;
            font-size: 15px !important;
            border: 1px solid rgba(255,255,255,0.9) !important;
            border-radius: 6px;
            letter-spacing: 0.01em;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.03) !important;
            height: 44px;
            min-height: 44px;
            box-sizing: border-box;
        }

        /* Layout: two-column aligned grid for left/right fields inside each data set */
        .data-set .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px 20px; /* row-gap / column-gap */
            align-items: start; /* align items vertically */
        }

        /* Each labeled field stacks label + input with consistent spacing */
        .data-set .field {
            display: flex;
            flex-direction: column;
            gap: 6px; /* consistent spacing between label and input */
            justify-content: flex-start;
        }

        .data-set .field label {
            margin: 0;
            font-size: 0.95rem;
            color: #ffffff; /* bright white */
            text-shadow: 0 1px 0 rgba(255,255,255,0.06), 0 2px 6px rgba(0,0,0,0.35);
            font-weight: 600;
        }

        /* Ensure inputs in both columns align to the same baseline/height */
        .data-set .form-grid .field .input-field,
        .data-set .form-grid .field .readonly-field {
            width: 100%;
            height: 44px;
            min-height: 44px;
        }

        /* Text alignment inside inputs */
        .input-field, select.input-field {
            text-align: left;
            vertical-align: middle;
            display: inline-block;
        }

        /* Responsive: single column on narrow screens */
        @media (max-width: 768px) {
            .data-set .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .data-set { animation: slideIn 0.45s ease-out; }

    /* Notification theme to match AIS colors */
    .notify-ais-success { background: linear-gradient(90deg, var(--ais-green), var(--ais-accent)); color: #fff; }
    .notify-ais-error { background: linear-gradient(90deg, #ef4444, #dc2626); color: #fff; }
    .notify-ais-info { background: linear-gradient(90deg, var(--ais-info), #4ad6d6); color: #fff; }
    .notify-ais-warning { background: linear-gradient(90deg, #f59e0b, #f97316); color: #fff; }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-step {
            transition: all 0.3s ease;
        }
        
        .progress-step.active {
            background: #16a34a;
            color: white;
        }
        
        .progress-step.completed {
            background: #059669;
            color: white;
        }
        
        .notification {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .modal-backdrop {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        @media (max-width: 768px) {
            .input-field {
                font-size: 16px !important;
            }
            
            .btn-glow, .button-glow {
                min-height: 44px;
            }
        }
    </style>
    <!-- LEGACY / OLD MOBILE SUPPORT START -->
    <style>
        /* Fallback ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏ñ‡πâ‡∏≤ gradient ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏¢‡∏±‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å) */
        body { background-color:#1e40af; }
        /* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö backdrop-filter ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß‡πÇ‡∏õ‡∏£‡πà‡∏á‡∏´‡∏ô‡∏≤‡πÅ‡∏ó‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ö‡∏ô iOS <12 / Android ‡πÄ‡∏Å‡πà‡∏≤ */
        .no-backdrop .glass,
        .no-backdrop .glass-strong,
        .no-backdrop .glass-light { 
            backdrop-filter:none !important; 
            -webkit-backdrop-filter:none !important; 
            -moz-backdrop-filter:none !important;
            background:rgba(255,255,255,0.88) !important; 
            border-color:rgba(0,0,0,0.08) !important;
        }
        /* ‡∏•‡∏î‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏á‡∏≤/‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô ‡∏´‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ (‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏•‡∏≤‡∏™ reduced-effects ‡∏à‡∏≤‡∏Å JS) */
        .reduced-effects * { transition:none !important; animation:none !important; }
        .reduced-effects .btn-glow:hover, .reduced-effects .button-glow:hover { transform:none !important; box-shadow:none !important; }
    </style>
    <script>
        /* Feature / capability detection + polyfills loader ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πà‡∏≤ */
        (function(){
            var docEl = document.documentElement;
            try {
                if(!(window.CSS && CSS.supports && CSS.supports('backdrop-filter: blur(4px)'))){
                    docEl.classList.add('no-backdrop');
                }
            } catch(e){ docEl.classList.add('no-backdrop'); }

            // ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Ñ‡∏£‡πà‡∏≤‡∏ß ‡πÜ (‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏Å‡πà‡∏≤: ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ï‡πà‡∏≥ / CPU ‡∏ä‡πâ‡∏≤ -> ‡∏õ‡∏¥‡∏î‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏´‡∏ô‡∏±‡∏Å ‡πÜ)
            if(navigator.hardwareConcurrency && navigator.hardwareConcurrency < 4){
                docEl.classList.add('reduced-effects');
            }

            // Polyfill: Promise
            if(typeof Promise === 'undefined'){
                var p = document.createElement('script');
                p.src = 'https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js';
                document.head.appendChild(p);
            }
            // Polyfill: fetch
            if(typeof fetch === 'undefined'){
                var f = document.createElement('script');
                f.src = 'https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.20/dist/fetch.umd.min.js';
                document.head.appendChild(f);
            }
            // Polyfill: IntersectionObserver (‡πÉ‡∏ä‡πâ‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)
            if(!('IntersectionObserver' in window)){
                var io = document.createElement('script');
                io.src = 'https://cdn.jsdelivr.net/npm/intersection-observer@0.12.2/intersection-observer.js';
                document.head.appendChild(io);
            }
            // NodeList.forEach ‡∏ö‡∏ô IE / ‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡∏Å (‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô WebView ‡πÄ‡∏Å‡πà‡∏≤)
            if(window.NodeList && !NodeList.prototype.forEach){
                NodeList.prototype.forEach = Array.prototype.forEach;
            }
            // classList ‡∏ö‡∏≤‡∏á WebView ‡πÄ‡∏Å‡πà‡∏≤‡∏Ç‡∏≤‡∏î (‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏¥‡∏ß‡πÄ‡∏ú‡∏¥‡∏ô)
            if(!('classList' in document.createElement('_'))){
                try { (document.createElement('script').src='https://unpkg.com/classlist-polyfill@1.2.0/src/index.js'); } catch(e){}
            }
        })();
    </script>
    <!-- LEGACY / OLD MOBILE SUPPORT END -->
</head>
<body class="min-h-screen">
    <!-- Header Section (cleaned) -->
    <div class="glass-strong header-hero mx-4 mt-4 p-6 mb-6">
        <!-- Decorative bubbles layer -->
        <div class="header-bubbles" aria-hidden="true">
            <div class="bubble small" style="left:8%; bottom:12%; animation-duration:6s; animation-delay:0s;"></div>
            <div class="bubble medium" style="left:22%; bottom:6%; animation-duration:5.5s; animation-delay:0.6s;"></div>
            <div class="bubble small" style="left:40%; bottom:14%; animation-duration:7s; animation-delay:0.9s;"></div>
            <div class="bubble large" style="left:60%; bottom:8%; animation-duration:6.5s; animation-delay:0.3s;"></div>
            <div class="bubble medium" style="left:78%; bottom:16%; animation-duration:5.8s; animation-delay:0.7s;"></div>
        </div>
        <div style="display:flex;align-items:center;justify-content:center;min-height:72px;position:relative;z-index:2;">
            <h1 class="text-3xl md:text-4xl font-medium tracking-normal m-0" style="line-height:1.1;">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ú‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï 2</h1>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="glass rounded-lg mx-4 mb-6 p-6">
        <div class="flex justify-center">
            <div class="flex items-center bg-white bg-opacity-50 rounded-lg px-4 py-2">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="dataGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#00b140;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00a3a3;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect fill="url(#dataGrad)" x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line stroke="white" stroke-width="2" x1="16" y1="2" x2="16" y2="6"/>
                    <line stroke="white" stroke-width="2" x1="8" y1="2" x2="8" y2="6"/>
                    <line stroke="white" stroke-width="2" x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <span class="font-normal text-gray-900 text-base">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <span id="dataSetCount" class="text-blue-600 font-medium">1</span>/<span class="text-gray-900">100</span></span>
            </div>
        </div>
    </div>

    <!-- Data Entry Container -->
    <div id="dataContainer" class="mx-4 space-y-6">
        <!-- Data sets will be generated here -->
    </div>

    <!-- Quick Actions Box -->
    <div class="glass rounded-lg mx-4 my-6 p-6">
        <div class="flex flex-wrap gap-4 justify-center">
            <button onclick="addDataSet()" class="btn-glow btn-green text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <i class="bi bi-plus-circle w-5 h-5 mr-2" aria-hidden="true" style="font-size:1.05rem"></i>
                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
            </button>
            
            <button onclick="copyAndAddDataSet()" class="btn-glow btn-blue text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <i class="bi bi-files w-5 h-5 mr-2" aria-hidden="true" style="font-size:1.05rem"></i>
                ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
            
            <button onclick="clearLocalStorage()" class="btn-glow btn-red text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <i class="bi bi-trash w-5 h-5 mr-2" aria-hidden="true" style="font-size:1.05rem"></i>
                ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            </button>
            
            <button onclick="resetToSingleDataSet()" class="btn-glow btn-red text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <i class="bi bi-arrow-repeat w-5 h-5 mr-2" aria-hidden="true" style="font-size:1.05rem"></i>
                ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
            
            <button onclick="resetToSingleDataSet()" class="btn-glow btn-red text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <i class="bi bi-arrow-repeat w-5 h-5 mr-2" aria-hidden="true" style="font-size:1.05rem"></i>
                ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
            
            <button onclick="showSystemHealth()" class="btn-glow btn-ais-info px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <i class="bi bi-heart-pulse w-5 h-5 mr-2" aria-hidden="true" style="font-size:1.05rem"></i>
                ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="glass rounded-lg mx-4 my-6 p-6">
        <div class="flex flex-wrap gap-4 justify-center">
            <button onclick="saveToLocalStorage(true)" class="btn-glow btn-purple text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <i class="bi bi-save w-5 h-5 mr-2" aria-hidden="true" style="font-size:1.05rem"></i>
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            </button>
            
            <button onclick="submitData()" class="btn-glow btn-orange text-white px-6 py-3 rounded-lg font-normal text-base flex items-center">
                <i class="bi bi-check2-circle w-5 h-5 mr-2" aria-hidden="true" style="font-size:1.05rem"></i>
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
        </div>
    </div>

    <!-- Usage instructions removed per user request -->

    <!-- Modals -->
    <!-- Machine Modal -->
    <div id="machineModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="glass-strong rounded-lg max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="machineGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#00b140;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#00a3a3;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect fill="url(#machineGrad)" x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                        <line stroke="white" stroke-width="2" x1="8" y1="21" x2="16" y2="21"/>
                        <line stroke="white" stroke-width="2" x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠‡πÉ‡∏´‡∏°‡πà
                </h3>
                <button onclick="closeModal('machine')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newMachine" placeholder="‡πÄ‡∏ä‡πà‡∏ô CL96" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('machine')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button onclick="closeModal('machine')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Employee Modal -->
    <div id="employeeModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="glass-strong rounded-lg max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="employeeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#00b140;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#00a3a3;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path fill="url(#employeeGrad)" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                </h3>
                <button onclick="closeModal('employee')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newEmployeeId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ZP99999" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-3">
            <input type="text" id="newEmployeeName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('employee')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button onclick="closeModal('employee')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Fabric Size Modal -->
    <div id="fabricModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="glass-strong rounded-lg max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="fabricGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#00b140;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#00a3a3;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect fill="url(#fabricGrad)" x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <path stroke="white" stroke-width="2" d="m9 9 3 3-3 3m6-6h-6"/>
                    </svg>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
                </h3>
                <button onclick="closeModal('fabric')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newFabricSize" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2025800SMN" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('fabric')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button onclick="closeModal('fabric')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center">
        <div class="glass-strong rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                <p class="text-gray-600 mb-4" id="loadingStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                
                <!-- Progress Steps -->
                <div class="flex justify-between mb-4">
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step1">1</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step2">2</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step3">3</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step4">4</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step5">5</div>
                </div>
                
                <div class="text-sm text-gray-500">
                    <div>1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    <div>2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    <div>3. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</div>
                    <div>4. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    <div>5. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Recovery Modal -->
    <div id="recoveryModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="glass-strong rounded-lg max-w-md w-full p-6">
            <div class="flex items-center mb-4">
                <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="recoveryGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#00b140;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00a3a3;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#recoveryGrad)" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                </svg>
                <h3 class="text-xl font-bold text-gray-800">‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á</h3>
            </div>
            <p class="text-gray-600 mb-6">‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="flex gap-3">
                <button onclick="retryPendingSubmission()" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
                </button>
                <button onclick="discardPendingSubmission()" class="btn-glow btn-red text-white px-6 py-2 rounded-lg font-semibold">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <script>
        // Master Data Arrays
        const machines = [
            "CL1","CL2","CL3","CL4","CL5","CL6","CL7","CL8","CL9","CL12","CL13","CL14",
            "CL15","CL16","CL17","CL19","CL25","CL26","CL27","CL28","CL29","CL30","CL31",
            "CL32","CL33","CL44","CL45","CL46","CL47","CL48","CL49","CL50","CL51","CL52",
            "CL53","CL54","CL55","CL56","CL57","CL58","CL59","CL60","CL61","CL62","CL63",
            "CL64","CL65","CL66","CL67","CL68","CL69","CL70","CL71","CL72","CL73","CL74",
            "CL75","CL76","CL77","CL78","CL79","CL80","CL81","CL82","CL83","CL84","CL85",
            "CL86","CL87","CL88","CL89","CL90","CL91","CL92","CL93","CL94","CL95","CL91",
            "CL90","CL34","CL35","CL36"
        ];

        const employees = [
            { "id": "ZP91042", "name": "‡∏ô‡∏≤‡∏¢ ‡∏ß‡∏±‡∏ô ‡∏ä‡∏±‡∏¢" },
            { "id": "ZP91385", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏£‡∏±‡∏ê‡∏ô‡∏±‡∏ô‡∏ó‡πå ‡∏ô‡∏¥‡∏ò‡∏≤‡∏Å‡∏£‡∏ì‡πå" },
            { "id": "ZP92285", "name": "‡∏ô‡∏≤‡∏¢‡∏ï‡∏≤‡∏•‡∏ã‡∏¥‡∏ô ‡∏≠‡∏≠‡∏á" },
            { "id": "ZP91702", "name": "‡∏ô‡∏≤‡∏¢ ‡∏û‡∏¥‡∏ß ‡πÑ‡∏ß ‡∏à‡∏≠" },
            { "id": "ZP92237", "name": "‡∏ã‡∏≠ ‡∏û‡∏π ‡∏¢‡∏≤ ‡∏ã‡∏≤" },
            { "id": "ZP92286", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏ã‡∏¥‡∏Å ‡πÄ‡∏Ñ‡πà‡∏ô" },
            { "id": "ZP92250", "name": "‡∏¢‡∏∏‡∏ô ‡∏ß‡∏≤ ‡∏ï‡∏¥" },
            { "id": "ZP91720", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏à‡∏π ‡∏à‡∏π ‡∏ã‡∏≤‡∏ô" },
            { "id": "ZP92187", "name": "‡∏ï‡∏¥‡∏ô ‡πÇ‡∏° ‡πÅ‡∏ó‡πá‡∏Ñ" },
            { "id": "ZP92282", "name": "‡∏õ‡∏≤‡∏•‡∏≤‡∏°‡∏≠‡∏ô" },
            { "id": "ZP91922", "name": "‡∏ô‡∏≤‡∏¢ ‡πÄ‡∏û‡∏µ‡∏¢ ‡πÇ‡∏ã ‡∏≠‡∏π" },
            { "id": "ZP92434", "name": "‡∏ô.‡∏™.‡∏•‡∏≥‡πÑ‡∏¢ ‡πÉ‡∏à‡∏ä‡∏∑‡πà‡∏≠" },
            { "id": "ZP92471", "name": "‡∏ô‡∏≤‡∏á‡∏°‡∏≠‡∏ß ‡∏°‡∏≠‡∏ß ‡∏ß‡∏¥‡∏ô" },
            { "id": "ZP91512", "name": "‡∏ô‡∏≤‡∏á ‡∏ô‡∏±‡∏ô ‡∏°‡∏≤ ‡πÄ‡∏• ‡∏¢‡∏µ" },
            { "id": "ZP92321", "name": "‡∏ô.‡∏™.‡∏°‡∏∞‡∏ã‡∏π‡∏ã‡∏π‡πÄ‡∏¢" },
            { "id": "ZP92491", "name": "‡∏ô‡∏≤‡∏á‡∏°‡∏≤ ‡∏ó‡∏≤‡∏ã‡∏¥‡∏ô ‡∏°‡∏ô" },
            { "id": "ZP91680", "name": "‡∏ô‡∏≤‡∏á ‡∏ï‡∏¥‡∏ô ‡∏ã‡∏∏‡∏¢" },
            { "id": "ZP9499", "name": "‡∏ô‡∏≤‡∏á ‡∏à‡∏≥‡∏£‡∏±‡∏® ‡∏û‡∏∏‡∏ó‡∏ò‡∏≤" },
            { "id": "ZP91569", "name": "‡∏ô‡∏≤‡∏¢ ‡∏ß‡∏±‡∏ä‡∏ä‡∏£‡∏∞ ‡∏ä‡∏∞‡∏é‡∏≤‡∏î‡∏≥" },
            { "id": "ZP92350", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏ã‡∏¥‡∏ô‡∏°‡∏≤‡∏•‡∏ß‡∏¥‡∏ô" },
            { "id": "ZP91719", "name": "‡∏ô‡∏≤‡∏¢ ‡∏û‡∏µ ‡∏û‡∏¥‡∏ß ‡∏≠‡∏≠‡∏á" },
            { "id": "ZP9060", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏≠‡∏±‡∏á‡∏Ñ‡∏ì‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏ò‡∏£‡∏£‡∏°" },
            { "id": "ZP92495", "name": "‡∏ô‡∏≤‡∏á‡∏û‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå" },
            { "id": "ZP9174", "name": "‡∏ô‡∏≤‡∏á ‡∏£‡∏±‡∏î‡∏î‡∏≤ ‡∏®‡∏£‡∏µ‡∏ó‡∏≠‡∏á" },
            { "id": "ZP92186", "name": "‡∏ã‡∏≤‡∏°‡∏¥‡∏ô‡∏≠‡∏π" },
            { "id": "ZP92317", "name": "‡∏ô‡∏≤‡∏¢ ‡∏¢‡∏≤‡∏ô ‡∏•‡∏¥‡∏ô ‡∏≠‡∏≠‡∏á" },
            { "id": "ZP92402", "name": "‡∏ô‡∏≤‡∏¢ ‡∏•‡∏≤ ‡∏ß‡∏¥‡∏ô" },
            { "id": "ZP91718", "name": "‡∏ô‡∏≤‡∏¢ ‡∏´‡∏°‡πà‡∏≠‡∏á ‡∏ã‡∏≠" },
            { "id": "ZP92425", "name": "‡∏ô.‡∏™.‡∏ß‡∏¥" },
            { "id": "ZP92318", "name": "‡∏ô.‡∏™.‡∏Ñ‡∏¥‡∏ô‡∏ß‡∏¥‡∏ô" },
            { "id": "ZP91617", "name": "‡∏ô‡∏≤‡∏á ‡∏û‡∏¥‡πÑ‡∏•‡∏û‡∏£‡∏£‡∏ì ‡πÄ‡∏ï‡πÇ‡∏ä" },
            { "id": "ZP92481", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡∏ï‡∏¥‡πà‡∏ô ‡∏ã‡∏≤" },
            { "id": "ZP92390", "name": "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß ‡πÄ‡∏≠ ‡∏ß‡∏¥‡∏ô" },
            { "id": "ZP92107", "name": "‡∏ô‡∏≤‡∏á ‡∏à‡∏µ ‡∏õ‡∏¥‡∏¢‡∏õ‡∏£‡∏∞‡∏†‡∏≤‡∏Å‡∏∏‡∏•" }
        ];

        const fabricSizes  = [
"1425800",
"1725800",
"1825800SM",
"1921720",
"1925800",
"1925800SM",
"2021720UV",
"2021850UV",
"2025800",
"2025800SM",
"2025800SMN",
"2025850",
"2121670SM",
"2125650",
"2125800",
"2325650",
"2625650",
"262575051",
"2625800",
"2625850SM",
"2825850",
"scl052325650",
"test2025800",
"2321112512551"
        ];

        // API Configuration - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        const API_CONFIG = {
            // Primary endpoint (updated 2025-08-16)
            endpoint: 'https://script.google.com/macros/s/AKfycbzA2gzgLmT5sGuFra-rilh2qeoQDseYasEpNrbUhEK0h9tBkMfQRS4jccL6BgEa5ZiDlg/exec',
            
            // Backup endpoints (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ primary ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)
            backupEndpoints: [
                'https://script.google.com/macros/s/BACKUP_URL_1/exec',
                'https://script.google.com/macros/s/BACKUP_URL_2/exec'
            ],
            
            sheetId: '1rx7Upb0wmWb1Tw2Wxdqgq0rpa1STy84rWetmAZdfkAA',
            folderId: '1uomWJJjxHMvNWwZRB2S9NVqRqadVDBBZ',
            
            // Timeout ‡πÅ‡∏•‡∏∞ retry settings
            timeout: 30000, // 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            maxRetries: 5,
            retryDelay: 2000, // 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            
            // Version tracking
            apiVersion: '1.0',
            lastUpdated: '2024-12-19'
        };

        // Global Variables
        let dataSetCount = 1;
        let autoSaveInterval;
        let debounceTimer;
        
        // System Health Monitoring
        const SYSTEM_HEALTH = {
            lastSaveTime: null,
            saveFailureCount: 0,
            maxFailures: 10,
            isOnline: navigator.onLine,
            performanceMetrics: {
                loadTime: 0,
                saveTime: 0,
                errorCount: 0
            }
        };
        
        // Error Logging System
        const ERROR_LOG = {
            maxEntries: 100,
            entries: [],
            
            log: function(error, context = '') {
                const entry = {
                    timestamp: new Date().toISOString(),
                    error: error.toString(),
                    context: context,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                this.entries.unshift(entry);
                if (this.entries.length > this.maxEntries) {
                    this.entries.pop();
                }
                
                // Save to localStorage for debugging
                try {
                    localStorage.setItem('errorLog', JSON.stringify(this.entries));
                } catch (e) {
                    console.warn('Cannot save error log to localStorage');
                }
                
                console.error('System Error:', entry);
            },
            
            getRecentErrors: function(hours = 24) {
                const cutoff = new Date(Date.now() - hours * 60 * 60 * 1000);
                return this.entries.filter(entry => new Date(entry.timestamp) > cutoff);
            }
        };

        // Initialize System - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
        document.addEventListener('DOMContentLoaded', function() {
            const startTime = performance.now();
            
            try {
                console.log('üöÄ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô‡∏ú‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï 2 ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                
                // Initialize system health monitoring
                initializeSystemHealth();
                
                // Setup error handling
                setupGlobalErrorHandling();
                
                // Initialize UI components
                // show static timestamp per user request
                try {
                    const timeEl = document.getElementById('currentTime');
                    if (timeEl) timeEl.textContent = '15/08/2568 13:38:45';
                } catch(e){}
                // live clock disabled: updateCurrentTime();
                // setInterval(updateCurrentTime, 1000);
                
                // Create initial data sets with error handling
                try {
                    const container = document.getElementById('dataContainer');
                    if (!container) {
                        throw new Error('Data container not found');
                    }
                    
                    for (let i = 1; i <= 1; i++) {
                        const newDataSet = document.createElement('div');
                        newDataSet.innerHTML = generateDataSet(i);
                        container.appendChild(newDataSet.firstElementChild);
                    }
                    dataSetCount = 1;
                    updateDataSetCount();
                } catch (error) {
                    ERROR_LOG.log(error, 'Initial data set creation');
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà', 'error');
                }
                
                // Setup event listeners with error handling
                setupEventListeners();
                setupSelectHandlers();
                setupNetworkMonitoring();
                
                // Check for pending submissions
                checkForPendingSubmissions();
                
                // Setup auto-save with improved interval
                setupAutoSave();
                
                // Load existing data if available
                loadFromLocalStorage();
                
                // Performance tracking
                const loadTime = performance.now() - startTime;
                SYSTEM_HEALTH.performanceMetrics.loadTime = loadTime;
                console.log(`‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô ${loadTime.toFixed(2)}ms`);
                
                // Show system ready notification
                setTimeout(() => {
                    showNotification('‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
                }, 1000);
                
            } catch (error) {
                ERROR_LOG.log(error, 'System initialization');
                console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà', 'error');
            }
        });

        // System Health Functions
        function initializeSystemHealth() {
            // Check browser compatibility
            if (!window.localStorage) {
                showNotification('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'warning');
            }
            
            // Check available storage
            try {
                const testKey = 'storageTest';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
            } catch (e) {
                showNotification('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡πá‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤', 'warning');
            }
            
            SYSTEM_HEALTH.isOnline = navigator.onLine;
        }
        
        function setupGlobalErrorHandling() {
            // Handle uncaught errors
            window.addEventListener('error', function(event) {
                ERROR_LOG.log(event.error, `Global error: ${event.filename}:${event.lineno}`);
                SYSTEM_HEALTH.performanceMetrics.errorCount++;
            });
            
            // Handle unhandled promise rejections
            window.addEventListener('unhandledrejection', function(event) {
                ERROR_LOG.log(event.reason, 'Unhandled promise rejection');
                SYSTEM_HEALTH.performanceMetrics.errorCount++;
            });
        }
        
        function setupNetworkMonitoring() {
            // Monitor online/offline status
            window.addEventListener('online', function() {
                SYSTEM_HEALTH.isOnline = true;
                showNotification('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß', 'success');
                
                // Try to sync pending data
                checkForPendingSubmissions();
            });
            
            window.addEventListener('offline', function() {
                SYSTEM_HEALTH.isOnline = false;
                showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', 'warning');
            });
        }
        
        function setupAutoSave() {
            // Clear existing interval if any
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            // Auto-save every 3 minutes (reduced from 5 for better reliability)
            autoSaveInterval = setInterval(() => {
                try {
                    saveToLocalStorage();
                } catch (error) {
                    ERROR_LOG.log(error, 'Auto-save failed');
                }
            }, 180000);
            
            // Also save before page unload
            window.addEventListener('beforeunload', function(e) {
                try {
                    saveToLocalStorage();
                } catch (error) {
                    ERROR_LOG.log(error, 'Before unload save failed');
                }
            });
        }

        // Update current time display
        function updateCurrentTime() {
            try {
                const now = new Date();
                const timeString = now.toLocaleString('th-TH', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = timeString;
                }
            } catch (error) {
                ERROR_LOG.log(error, 'Update time failed');
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Prevent accidental page leave
            window.addEventListener('beforeunload', function(e) {
                const hasData = document.querySelectorAll('.data-set').length > 0;
                if (hasData) {
                    e.preventDefault();
                    e.returnValue = '';
                    saveToLocalStorage();
                }
            });

            // Auto-save on input changes
            document.addEventListener('input', function(e) {
                if (e.target.matches('.input-field')) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(saveToLocalStorage, 2000);
                }
            });
        }

        // Generate Data Set HTML
        function generateDataSet(setNumber) {
            const today = new Date().toISOString().split('T')[0];
            
            return `
                <div class="data-set glass rounded-lg p-6 mb-6" data-set="${setNumber}">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-medium text-white flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <defs>
                                    <linearGradient id="setGrad${setNumber}" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect fill="url(#setGrad${setNumber})" x="3" y="4" width="18" height="15" rx="2" ry="2"/>
                                <polyline stroke="white" stroke-width="2" points="16,10 12,14 8,10"/>
                            </svg>
                            ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà ${setNumber}
                        </h2>
                        ${setNumber > 1 ? `
                            <button onclick="removeDataSet(${setNumber})" class="btn-glow btn-red text-white px-3 py-2 rounded-lg font-normal text-sm flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                                ‡∏•‡∏ö‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        ` : ''}
                    </div>

                    <div class="grid lg:grid-cols-3 gap-6 items-start">
                        <!-- Left column: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô -->
                        <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                            <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="basicGrad${setNumber}" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#00b140;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#00a3a3;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    <circle fill="url(#basicGrad${setNumber})" cx="12" cy="12" r="10"/>
                                    <path stroke="white" stroke-width="2" d="m9 12 2 2 4-4"/>
                                </svg>
                                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                            </h3>

                            <div class="left-rows" style="display:grid;grid-template-rows:auto auto auto;gap:16px;">
                                <div class="field">
                                    <label for="date_${setNumber}">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                    <input type="date" id="date_${setNumber}" name="date_${setNumber}" value="${today}" class="input-field">
                                </div>

                                <div class="field">
                                    <label for="machine_${setNumber}">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠ NO</label>
                                    <select id="machine_${setNumber}" name="machine_${setNumber}" class="input-field">
                                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠</option>
                                        ${machines.map(machine => `<option value="${machine}">${machine}</option>`).join('')}
                                        <option value="ADD_NEW">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</option>
                                    </select>
                                </div>

                                <div class="field">
                                    <label for="fabricSize_${setNumber}">‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤</label>
                                    <select id="fabricSize_${setNumber}" name="fabricSize_${setNumber}" class="input-field">
                                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤</option>
                                        ${fabricSizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                                        <option value="ADD_NEW">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</option>
                                    </select>
                                </div>

                                <!-- lotNo moved to its own card (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Lot.No) per UI requirement -->
                            </div>
                        </div>

                        <!-- Right column: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô -->
                        <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                            <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="lengthGrad${setNumber}" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#00b140;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#00a3a3;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    <circle fill="url(#lengthGrad${setNumber})" cx="12" cy="12" r="10"/>
                                    <path stroke="white" stroke-width="2" d="M8 8h8M8 12h8M8 16h8"/>
                                </svg>
                                ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ï‡∏±‡∏î‡∏°‡πâ‡∏ß‡∏ô (‡πÄ‡∏°‡∏ï‡∏£)
                            </h3>

                            <div class="right-rows" style="display:grid;grid-template-rows:auto auto auto;gap:16px;">
                                <div class="field">
                                    <label for="lengthA_${setNumber}">‡∏Å‡∏∞ A</label>
                                    <input type="number" id="lengthA_${setNumber}" name="lengthA_${setNumber}" class="input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2500" step="0.01">
                                </div>

                                <div class="field">
                                    <label for="lengthB_${setNumber}">‡∏Å‡∏∞ B</label>
                                    <input type="number" id="lengthB_${setNumber}" name="lengthB_${setNumber}" class="input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2000" step="0.01">
                                </div>

                                <div class="field">
                                    <label>&nbsp;</label>
                                    <div style="height:44px">&nbsp;</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Third column: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Lot.No (moved) -->
                        <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                            <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="lotGrad${setNumber}" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#7c3aed;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#5b21b6;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    <circle fill="url(#lotGrad${setNumber})" cx="12" cy="12" r="10"/>
                                    <path stroke="white" stroke-width="2" d="M7 12h10M7 8h10M7 16h10"/>
                                </svg>
                                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Lot.No
                            </h3>

                            <div class="lot-rows" style="display:grid;grid-template-rows:auto;gap:16px;">
                                <div class="field">
                                    <label for="lotNo_${setNumber}">‡∏Ç‡∏ô‡∏≤‡∏î Lot.No</label>
                                    <input type="text" id="lotNo_${setNumber}" name="lotNo_${setNumber}" class="input-field" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà Lot.No">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            `;
        }

        // Add Data Set
        function addDataSet() {
            if (dataSetCount >= 100) {
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î 100 ‡∏ä‡∏∏‡∏î', 'error');
                return;
            }
            
            dataSetCount++;
            const container = document.getElementById('dataContainer');
            const newDataSet = document.createElement('div');
            newDataSet.innerHTML = generateDataSet(dataSetCount);
            const newElement = newDataSet.firstElementChild;
            container.appendChild(newElement);
            
            updateDataSetCount();
            
            // Setup handlers after a short delay to ensure DOM is ready
            setTimeout(() => {
                setupSelectHandlers();
                showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà ${dataSetCount} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'green');
                
                // Scroll to new data set
                newElement.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // Copy and Add Data Set
        function copyAndAddDataSet() {
            if (dataSetCount >= 100) {
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î 100 ‡∏ä‡∏∏‡∏î', 'error');
                return;
            }
            
            const lastDataSet = document.querySelector(`[data-set="${dataSetCount}"]`);
            if (!lastDataSet) {
                addDataSet();
                return;
            }
            
            // Get data from last set
            const lastData = {};
            const inputs = lastDataSet.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (!input.readOnly && !input.disabled && input.value) {
                    const fieldName = input.name.replace(`_${dataSetCount}`, '');
                    lastData[fieldName] = input.value;
                }
            });
            
            // Create new data set
            dataSetCount++;
            const container = document.getElementById('dataContainer');
            const newDataSet = document.createElement('div');
            newDataSet.innerHTML = generateDataSet(dataSetCount);
            const newElement = newDataSet.firstElementChild;
            container.appendChild(newElement);
            
            // Fill with copied data after a short delay to ensure DOM is ready
            setTimeout(() => {
                const newInputs = newElement.querySelectorAll('input, select');
                newInputs.forEach(input => {
                    if (!input.readOnly && !input.disabled) {
                        const fieldName = input.name.replace(`_${dataSetCount}`, '');
                        if (lastData[fieldName]) {
                            input.value = lastData[fieldName];
                        }
                    }
                });
                
                // Setup handlers for the new data set
                setupSelectHandlers();
                
                showNotification(`‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà ${dataSetCount} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'blue');
                
                // Scroll to new data set
                newElement.scrollIntoView({ behavior: 'smooth' });
            }, 100);
            
            updateDataSetCount();
        }

        // Remove Data Set
        function removeDataSet(setNumber) {
            if (dataSetCount <= 1) {
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ', 'error');
                return;
            }
            
            const dataSet = document.querySelector(`[data-set="${setNumber}"]`);
            if (dataSet) {
                dataSet.remove();
                dataSetCount--;
                updateDataSetCount();
                showNotification(`‡∏•‡∏ö‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà ${setNumber} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'red');
            }
        }

        // Update Data Set Count Display
        function updateDataSetCount() {
            document.getElementById('dataSetCount').textContent = dataSetCount;
        }

        // Setup Select Handlers
        function setupSelectHandlers() {
            document.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', function() {
                    if (this.value === 'ADD_NEW') {
                        const fieldType = this.name.includes('machine') ? 'machine' : 
                                        this.name.includes('employee') ? 'employee' : 'fabric';
                        openModal(fieldType);
                        this.value = ''; // Reset select
                    }
                });
            });
        }

        // Modal Functions
        function openModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            modal.classList.remove('hidden');
            
            // Clear previous inputs
            if (type === 'employee') {
                document.getElementById('newEmployeeId').value = '';
                document.getElementById('newEmployeeName').value = '';
            } else {
                document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}${type === 'fabric' ? 'Size' : ''}`).value = '';
            }
        }

        function closeModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            modal.classList.add('hidden');
        }

        function saveModalData(type) {
            let newValue = '';
            let isValid = false;
            
            if (type === 'employee') {
                const id = document.getElementById('newEmployeeId').value.trim();
                const name = document.getElementById('newEmployeeName').value.trim();
                
                if (id && name) {
                    newValue = id;
                    employees.push({ id: id, name: name });
                    isValid = true;
                }
            } else if (type === 'machine') {
                newValue = document.getElementById('newMachine').value.trim();
                if (newValue) {
                    machines.push(newValue);
                    isValid = true;
                }
            } else if (type === 'fabric') {
                newValue = document.getElementById('newFabricSize').value.trim();
                if (newValue) {
                    fabricSizes.push(newValue);
                    isValid = true;
                }
            }
            
            if (isValid) {
                updateAllSelects(type, newValue);
                closeModal(type);
                showNotification(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            } else {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
            }
        }

        // Update All Selects
        function updateAllSelects(type, newValue) {
            const selects = document.querySelectorAll(`select[name*="${type === 'employee' ? 'employee' : type === 'fabric' ? 'fabricSize' : 'machine'}"]`);
            
            selects.forEach(select => {
                // Remove old ADD_NEW option
                const addNewOption = select.querySelector('option[value="ADD_NEW"]');
                if (addNewOption) {
                    addNewOption.remove();
                }
                
                // Add new option
                const newOption = document.createElement('option');
                if (type === 'employee') {
                    const emp = employees.find(e => e.id === newValue);
                    newOption.value = newValue;
                    newOption.textContent = `${emp.id} - ${emp.name}`;
                } else {
                    newOption.value = newValue;
                    newOption.textContent = newValue;
                }
                select.appendChild(newOption);
                
                // Re-add ADD_NEW option
                const addNewOptionNew = document.createElement('option');
                addNewOptionNew.value = 'ADD_NEW';
                addNewOptionNew.textContent = '‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà';
                select.appendChild(addNewOptionNew);
                
                // Select the new value
                select.value = newValue;
            });
        }

        // Refresh All Selects
        function refreshAllSelects() {
            // Refresh machine selects
            document.querySelectorAll('select[name*="machine"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≠</option>
                    ${machines.map(machine => `<option value="${machine}">${machine}</option>`).join('')}
                    <option value="ADD_NEW">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</option>
                `;
                select.value = currentValue;
            });
            
            // Refresh employee selects
            document.querySelectorAll('select[name*="employee"]').forEach(select => {
                if (!select.name.includes('employeeB')) {
                    const currentValue = select.value;
                    select.innerHTML = `
                        <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>
                        ${employees.map(emp => `<option value="${emp.id}">${emp.id} - ${emp.name}</option>`).join('')}
                        <option value="ADD_NEW">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</option>
                    `;
                    select.value = currentValue;
                }
            });
            
            // Refresh fabric selects
            document.querySelectorAll('select[name*="fabricSize"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡πâ‡∏≤</option>
                    ${fabricSizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                    <option value="ADD_NEW">‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</option>
                `;
                select.value = currentValue;
            });
        }

        // Data Submission Functions
        async function submitData() {
            console.log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            
            const allData = collectAllData();
            if (!allData || allData.length === 0) {
                showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á', 'error');
                return;
            }
            
            // Save data for recovery before submission
            saveDataForRecovery(allData);
            
            showLoading();
            updateProgressStep(1);
            updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            const payload = {
                action: 'saveData',
                data: {
                    title: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï 2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏Å‡∏∞ A",
                    timestamp: new Date().toISOString(),
                    totalSets: allData.length,
                    data: allData
                },
                sheetId: API_CONFIG.sheetId,
                folderId: API_CONFIG.folderId,
                timestamp: new Date().toISOString()
            };
            
            try {
                await submitWithRetry(payload, 3, 1);
            } catch (error) {
                console.error('‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);
                hideLoading();
                showNotification('‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
            }
        }

        async function submitWithRetry(data, maxRetries, currentAttempt, useBackup = false) {
            console.log(`üîÑ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentAttempt}/${maxRetries}${useBackup ? ' (‡πÉ‡∏ä‡πâ backup)' : ''}`);
            updateProgressStep(2);
            updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            if (!SYSTEM_HEALTH.isOnline) throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
            await new Promise(r => setTimeout(r, 1000));
            updateProgressStep(3);
            updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...');
            let endpoint = API_CONFIG.endpoint;
            if (useBackup && API_CONFIG.backupEndpoints.length > 0) {
                const backupIndex = (currentAttempt - 1) % API_CONFIG.backupEndpoints.length;
                endpoint = API_CONFIG.backupEndpoints[backupIndex];
                console.log(`üîÑ ‡πÉ‡∏ä‡πâ backup endpoint: ${endpoint}`);
            }
            try {
                const submissionId = (self.crypto && crypto.randomUUID ? crypto.randomUUID() : 'sub-' + Date.now() + '-' + Math.random().toString(16).slice(2));
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);
                const payload = { ...data, submissionId, systemInfo: { userAgent: navigator.userAgent, timestamp: new Date().toISOString(), attempt: currentAttempt, endpoint } };
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4 ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                updateProgressStep(4);
                updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                // ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤ UI ‡∏ß‡∏≤‡∏î‡∏ú‡∏•‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
                await new Promise(r => setTimeout(r, 80));

                // Simple request (‡∏´‡∏•‡∏ö preflight)
                const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload), signal: controller.signal, cache: 'no-store', keepalive: true });
                clearTimeout(timeoutId);
                let ok = response.ok; let txt=''; let json=null;
                try { txt = await response.text(); if (txt) { try { json = JSON.parse(txt); } catch(_){} } } catch(_){}
                const logicalSuccess = json && (json.success === true || json.status === 'ok');
                if (!ok || !logicalSuccess) {
                    const pending = { savedAt: new Date().toISOString(), submissionId, endpoint, httpStatus: response.status, ok, logicalSuccess, bodySample: (txt||'').slice(0,500), payload };
                    localStorage.setItem('pendingSubmission', JSON.stringify(pending));
                    throw new Error('‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß HTTP:' + response.status + ' successFlag:' + logicalSuccess);
                }
                updateProgressStep(5);
                updateLoadingStatus('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
                // ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                await new Promise(r => setTimeout(r, 200));
                localStorage.removeItem('pendingSubmission');
                SYSTEM_HEALTH.saveFailureCount = 0; SYSTEM_HEALTH.lastSaveTime = new Date();
                const totalRows = (data && data.data && data.data.data) ? data.data.data.length : 0;
                hideLoading();
                showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à '+ totalRows +' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'orange');
                console.log('‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', { submissionId, totalRows, response: json });
            } catch (error) {
                const isLikelyCors = (error instanceof TypeError) || /fetch|network|cors/i.test(error.message || '');
                if (currentAttempt === 1 && isLikelyCors) {
                    try {
                        console.warn('‚ö†Ô∏è Simple POST ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏≠‡∏≤‡∏à‡∏ï‡∏¥‡∏î CORS -> ‡∏•‡∏≠‡∏á JSONP');
                        const jsonpResult = await jsonpFallback(data, endpoint);
                        if (jsonpResult && jsonpResult.success) {
                            const totalRows = (data && data.data && data.data.data) ? data.data.data.length : 0;
                            updateProgressStep(5);
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 5 ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î
                            await new Promise(r => setTimeout(r, 200));
                            hideLoading();
                            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à '+ totalRows +' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'orange');
                            SYSTEM_HEALTH.saveFailureCount = 0; localStorage.removeItem('pendingSubmission');
                            return;
                        }
                    } catch (jsonpErr) { console.error('‚ùå JSONP fallback ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', jsonpErr); }
                }
                console.error(`‚ùå ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏µ‡πà ${currentAttempt} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:`, error);
                ERROR_LOG.log(error, `Submit attempt ${currentAttempt}`); SYSTEM_HEALTH.saveFailureCount++;
                if (currentAttempt < maxRetries) {
                    updateLoadingStatus(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà... (${currentAttempt + 1}/${maxRetries})`);
                    const delay = API_CONFIG.retryDelay * Math.pow(2, currentAttempt - 1);
                    await new Promise(r => setTimeout(r, delay));
                    const shouldUseBackup = currentAttempt >= 2; return submitWithRetry(data, maxRetries, currentAttempt + 1, shouldUseBackup);
                } else {
                    if (SYSTEM_HEALTH.saveFailureCount >= SYSTEM_HEALTH.maxFailures) showNotification('‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÜ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                    try { if (localStorage.getItem('pendingSubmission')) showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏• ‡πÄ‡∏ã‡∏ü pending ‡∏£‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà', 'warning'); } catch(_){}
                    throw error;
                }
            }
        }

        // JSONP fallback helper
        function jsonpFallback(originalPayload, endpoint) {
            return new Promise((resolve, reject) => {
                try {
                    if (!originalPayload || originalPayload.action !== 'saveData') return reject(new Error('JSONP ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ saveData'));
                    const minimal = { action: 'saveData', data: originalPayload.data };
                    const jsonStr = JSON.stringify(minimal);
                    const encoded = encodeURIComponent(jsonStr);
                    if (encoded.length > 7000) return reject(new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö JSONP'));
                    const cbName = '__jsonpCB_' + Date.now() + '_' + Math.random().toString(16).slice(2);
                    const url = endpoint + '?action=saveData&data=' + encoded + '&callback=' + cbName;
                    const script = document.createElement('script');
                    let timeoutId;
                    window[cbName] = function(resp){ clearTimeout(timeoutId); try { delete window[cbName]; } catch(_){} script.remove(); resolve(resp); };
                    script.onerror = function(){ clearTimeout(timeoutId); try { delete window[cbName]; } catch(_){} script.remove(); reject(new Error('JSONP script load error')); };
                    timeoutId = setTimeout(() => { try { delete window[cbName]; } catch(_){} script.remove(); reject(new Error('JSONP timeout')); }, 15000);
                    script.src = url; document.head.appendChild(script);
                } catch(err) { reject(err); }
            });
        }

        // Collect All Data
        function collectAllData() {
            const allData = [];
            const dataSets = document.querySelectorAll('.data-set');
            
            dataSets.forEach((dataSet, index) => {
                const setNumber = index + 1;
                const setData = {
                    setNumber: setNumber,
                    date: dataSet.querySelector(`[name="date_${setNumber}"]`)?.value || '',
                    machine: dataSet.querySelector(`[name="machine_${setNumber}"]`)?.value || '',
                    fabricSize: dataSet.querySelector(`[name="fabricSize_${setNumber}"]`)?.value || '',
                    lotNo: dataSet.querySelector(`[name="lotNo_${setNumber}"]`)?.value || '',
                    lengthA: dataSet.querySelector(`[name="lengthA_${setNumber}"]`)?.value || '',
                    lengthB: dataSet.querySelector(`[name="lengthB_${setNumber}"]`)?.value || ''
                };
                
                allData.push(setData);
            });
            
            return allData;
        }

        // Storage Functions - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
        function saveToLocalStorage() {
            const saveStartTime = performance.now();
            
            try {
                const allData = collectAllData();
                
                // Validate data before saving
                if (!allData || allData.length === 0) {
                    console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                    return;
                }
                
                const storageData = {
                    version: '2.0', // ‡πÄ‡∏û‡∏¥‡πà‡∏° version tracking
                    timestamp: new Date().toISOString(),
                    dataSetCount: dataSetCount,
                    data: allData,
                    customMachines: machines.slice(75), // Only custom additions
                    customEmployees: employees.slice(34), // Only custom additions
                    customFabricSizes: fabricSizes.slice(22), // Only custom additions
                    systemHealth: {
                        saveTime: saveStartTime,
                        errorCount: SYSTEM_HEALTH.performanceMetrics.errorCount,
                        lastSaveTime: SYSTEM_HEALTH.lastSaveTime
                    }
                };
                
                // Check storage size before saving
                const dataSize = JSON.stringify(storageData).length;
                const maxSize = 5 * 1024 * 1024; // 5MB limit
                
                if (dataSize > maxSize) {
                    // Clean old data if size is too large
                    cleanOldStorageData();
                }
                
                // Create backup before overwriting
                const existingData = localStorage.getItem('productionData');
                if (existingData) {
                    localStorage.setItem('productionDataBackup', existingData);
                }
                
                localStorage.setItem('productionData', JSON.stringify(storageData));
                
                const saveTime = performance.now() - saveStartTime;
                SYSTEM_HEALTH.performanceMetrics.saveTime = saveTime;
                SYSTEM_HEALTH.lastSaveTime = new Date();
                
                console.log(`üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß (${saveTime.toFixed(2)}ms, ${(dataSize/1024).toFixed(2)}KB)`);
                
                // Only show notification if manually triggered
                if (arguments.length > 0 && arguments[0] === true) {
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'purple');
                }
                
            } catch (error) {
                ERROR_LOG.log(error, 'Save to localStorage failed');
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ:', error);
                
                // Try to recover from backup
                if (error.name === 'QuotaExceededError') {
                    showNotification('‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡πá‡∏° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤...', 'warning');
                    cleanOldStorageData();
                    
                    // Try saving again
                    try {
                        localStorage.setItem('productionData', JSON.stringify(storageData));
                        showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    } catch (retryError) {
                        showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤', 'error');
                    }
                } else {
                    showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                }
            }
        }
        
        function cleanOldStorageData() {
            try {
                // Remove old error logs
                const errorLog = localStorage.getItem('errorLog');
                if (errorLog) {
                    const logs = JSON.parse(errorLog);
                    const recentLogs = logs.slice(0, 50); // Keep only 50 recent entries
                    localStorage.setItem('errorLog', JSON.stringify(recentLogs));
                }
                
                // Remove old backup data
                localStorage.removeItem('productionDataBackup');
                
                // Remove other temporary data
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('temp_') || key.startsWith('old_'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                console.log(`üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß (${keysToRemove.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                
            } catch (error) {
                ERROR_LOG.log(error, 'Clean old storage data failed');
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏î‡πâ:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('productionData');
                if (!stored) {
                    console.log('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ');
                    return;
                }
                
                const storageData = JSON.parse(stored);
                
                // Restore custom data
                if (storageData.customMachines) {
                    machines.push(...storageData.customMachines);
                }
                if (storageData.customEmployees) {
                    employees.push(...storageData.customEmployees);
                }
                if (storageData.customFabricSizes) {
                    fabricSizes.push(...storageData.customFabricSizes);
                }
                
                // Clear existing data sets
                document.getElementById('dataContainer').innerHTML = '';
                
                // Restore data sets
                dataSetCount = storageData.dataSetCount || 1;
                for (let i = 1; i <= dataSetCount; i++) {
                    const container = document.getElementById('dataContainer');
                    const newDataSet = document.createElement('div');
                    newDataSet.innerHTML = generateDataSet(i);
                    container.appendChild(newDataSet.firstElementChild);
                }
                
                // Fill data
                if (storageData.data) {
                    storageData.data.forEach((setData, index) => {
                        const setNumber = index + 1;
                        const dataSet = document.querySelector(`[data-set="${setNumber}"]`);
                        if (dataSet) {
                            Object.keys(setData).forEach(key => {
                                if (key !== 'setNumber') {
                                    const input = dataSet.querySelector(`[name="${key}_${setNumber}"]`);
                                    if (input && !input.readOnly) {
                                        input.value = setData[key];
                                    }
                                }
                            });
                        }
                    });
                }
                
                updateDataSetCount();
                setupSelectHandlers();
                refreshAllSelects();
                
                console.log('üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                
            } catch (error) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ:', error);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function clearLocalStorage() {
            try {
                localStorage.removeItem('productionData');
                localStorage.removeItem('pendingSubmission');
                console.log('üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
                showNotification('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'red');
            } catch (error) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ:', error);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Reset all data sets to a single fresh set
        function resetToSingleDataSet() {
            try {
                const ok = confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ 1 ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
                if (!ok) return;

                // Clear stored data for this module
                localStorage.removeItem('productionData');
                localStorage.removeItem('pendingSubmission');

                // Rebuild DOM with only one fresh data set
                const container = document.getElementById('dataContainer');
                if (!container) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö dataContainer');
                container.innerHTML = '';
                const wrapper = document.createElement('div');
                wrapper.innerHTML = generateDataSet(1);
                container.appendChild(wrapper.firstElementChild);

                // Reset counters and UI
                dataSetCount = 1;
                updateDataSetCount();
                setupSelectHandlers();

                // Persist the fresh state
                saveToLocalStorage();

                // UX
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showNotification('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'success');
            } catch (error) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ:', error);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // Recovery System
        function saveDataForRecovery(data) {
            try {
                const recoveryData = {
                    timestamp: new Date().toISOString(),
                    data: data
                };
                localStorage.setItem('pendingSubmission', JSON.stringify(recoveryData));
                console.log('üîÑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô');
            } catch (error) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ:', error);
            }
        }

        function checkForPendingSubmissions() {
            try {
                const pending = localStorage.getItem('pendingSubmission');
                if (pending) {
                    const recoveryData = JSON.parse(pending);
                    const timestamp = new Date(recoveryData.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - timestamp) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 1) {
                        // Auto cleanup old data
                        localStorage.removeItem('pendingSubmission');
                        console.log('üßπ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
                    } else {
                        // Show recovery modal
                        document.getElementById('recoveryModal').classList.remove('hidden');
                        console.log('üîÑ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á');
                    }
                }
            } catch (error) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ:', error);
            }
        }

        function retryPendingSubmission() {
            try {
                const pending = localStorage.getItem('pendingSubmission');
                if (pending) {
                    const recoveryData = JSON.parse(pending);
                    document.getElementById('recoveryModal').classList.add('hidden');
                    
                    const payload = {
                        action: 'saveData',
                        data: {
                            title: "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï 2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏Å‡∏∞ A (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô)",
                            timestamp: recoveryData.timestamp,
                            totalSets: recoveryData.data.length,
                            data: recoveryData.data
                        },
                        sheetId: API_CONFIG.sheetId,
                        folderId: API_CONFIG.folderId,
                        timestamp: new Date().toISOString()
                    };
                    
                    showLoading();
                    submitWithRetry(payload, 3, 1);
                }
            } catch (error) {
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ:', error);
                showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
            }
        }

        function discardPendingSubmission() {
            localStorage.removeItem('pendingSubmission');
            document.getElementById('recoveryModal').classList.add('hidden');
            showNotification('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πâ‡∏≤‡∏á‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        // UI Management Functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            // Reset progress steps
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                if (!step) continue;
                step.classList.remove('active', 'completed');
                // clear any previously applied inline styles
                step.style.backgroundColor = '';
                step.style.color = '';
                step.style.borderColor = '';
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        function updateProgressStep(stepNumber) {
            // Mark previous steps as completed
            for (let i = 1; i < stepNumber; i++) {
                const step = document.getElementById(`step${i}`);
                if (!step) continue;
                step.classList.remove('active');
                step.classList.add('completed');
                // apply inline styles so Tailwind utility classes don't hide state
                step.style.backgroundColor = '#059669';
                step.style.color = '#ffffff';
                step.style.borderColor = 'transparent';
            }
            
            // Mark current step as active
            const currentStep = document.getElementById(`step${stepNumber}`);
            if (currentStep) {
                currentStep.classList.add('active');
                currentStep.classList.remove('completed');
                currentStep.style.backgroundColor = '#16a34a';
                currentStep.style.color = '#ffffff';
                currentStep.style.borderColor = 'transparent';
            }

            // Reset any later steps (in case of retries) to neutral style
            for (let j = stepNumber + 1; j <= 5; j++) {
                const later = document.getElementById(`step${j}`);
                if (!later) continue;
                later.classList.remove('active', 'completed');
                later.style.backgroundColor = ''; // revert to class-based color
                later.style.color = '';
                later.style.borderColor = '';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgClass = type === 'success' ? 'notify-ais-success' : 
                           type === 'error' ? 'notify-ais-error' : 
                           type === 'warning' ? 'notify-ais-warning' : 
                           type === 'green' ? 'notify-ais-success' :
                           type === 'blue' ? 'notify-ais-info' :
                           type === 'purple' ? 'notify-ais-success' :
                           type === 'orange' ? 'notify-ais-warning' :
                           type === 'red' ? 'notify-ais-error' : 'notify-ais-info';

            notification.className = `notification ${bgClass} text-white px-6 py-4 rounded-lg shadow-lg flex items-center max-w-sm`;
            
            const icon = type === 'success' ? '‚úÖ' : 
                        type === 'error' ? '‚ùå' : 
                        type === 'warning' ? '‚ö†Ô∏è' : 
                        type === 'green' ? '‚úÖ' :
                        type === 'blue' ? '‚úÖ' :
                        type === 'purple' ? '‚úÖ' :
                        type === 'orange' ? '‚úÖ' :
                        type === 'red' ? '‚ÑπÔ∏è' : '‚ÑπÔ∏è';
            
            notification.innerHTML = `
                <span class="mr-3 text-xl">${icon}</span>
                <span class="font-semibold">${message}</span>
            `;
            
            document.getElementById('notifications').appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // System Health Check Function
        function showSystemHealth() {
            const healthData = {
                online: SYSTEM_HEALTH.isOnline,
                lastSave: SYSTEM_HEALTH.lastSaveTime,
                saveFailures: SYSTEM_HEALTH.saveFailureCount,
                loadTime: SYSTEM_HEALTH.performanceMetrics.loadTime,
                saveTime: SYSTEM_HEALTH.performanceMetrics.saveTime,
                errorCount: SYSTEM_HEALTH.performanceMetrics.errorCount,
                recentErrors: ERROR_LOG.getRecentErrors(24),
                storageUsed: getStorageUsage(),
                browserInfo: {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine
                }
            };
            
            let healthStatus = '‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥';
            let healthColor = 'success';
            
            if (!healthData.online) {
                healthStatus = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï';
                healthColor = 'warning';
            } else if (healthData.saveFailures > 5) {
                healthStatus = '‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                healthColor = 'error';
            } else if (healthData.errorCount > 10) {
                healthStatus = '‚ö†Ô∏è ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                healthColor = 'warning';
            }
            
            const healthReport = `
‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö: ${healthStatus}

üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û:
- ‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö: ${healthData.loadTime.toFixed(2)}ms
- ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${healthData.saveTime.toFixed(2)}ms
- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${healthData.errorCount}
- ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á: ${healthData.saveFailures}

üíæ ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö:
- ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß: ${(healthData.storageUsed.used/1024).toFixed(2)}KB
- ‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${(healthData.storageUsed.remaining/1024).toFixed(2)}KB

üåê ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:
- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${healthData.online ? '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠' : '‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'}
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${healthData.lastSave ? new Date(healthData.lastSave).toLocaleString('th-TH') : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢'}

${healthData.recentErrors.length > 0 ? `\n‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (24 ‡∏ä‡∏°.):\n${healthData.recentErrors.slice(0, 3).map(e => `- ${e.error.substring(0, 50)}...`).join('\n')}` : ''}
            `;
            
            // Copy to clipboard for easy sharing
            if (navigator.clipboard) {
                navigator.clipboard.writeText(healthReport).then(() => {
                    showNotification('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'success');
                });
            }
            
            console.log('üè• ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏£‡∏∞‡∏ö‡∏ö:', healthData);
            alert(healthReport);
            showNotification(healthStatus, healthColor);
        }
        
        function getStorageUsage() {
            try {
                let used = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        used += localStorage[key].length + key.length;
                    }
                }
                
                // Estimate remaining space (5MB typical limit)
                const estimated = 5 * 1024 * 1024;
                return {
                    used: used,
                    remaining: Math.max(0, estimated - used)
                };
            } catch (error) {
                return { used: 0, remaining: 0 };
            }
        }

        // Note: First data set is already created in the main DOMContentLoaded event
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96bc15dfc4018967',t:'MTc1NDYyNTQwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
